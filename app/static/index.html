<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>V-22 TAR Intelligence System</title>
  <style>
    /* ===================================================================
       CSS VARIABLES -- Color Scheme
       =================================================================== */
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --bg-card: #1e293b;
      --bg-card-hover: #253348;
      --bg-input: #0f172a;

      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --text-label: #cbd5e1;

      --accent-blue: #38bdf8;
      --accent-cyan: #22d3ee;
      --accent-green: #34d399;
      --accent-amber: #fbbf24;
      --accent-red: #f87171;
      --accent-purple: #a78bfa;

      --border-color: #334155;
      --border-focus: #38bdf8;

      --bar-replace: #38bdf8;
      --bar-inspect: #22d3ee;
      --bar-adjust: #34d399;
      --bar-repair: #fbbf24;
      --bar-other: #a78bfa;

      --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --font-mono: "SF Mono", "Fira Code", "Fira Mono", "Roboto Mono", Consolas, "Courier New", monospace;

      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;

      --shadow-card: 0 1px 3px rgba(0,0,0,0.3), 0 1px 2px rgba(0,0,0,0.2);
      --shadow-elevated: 0 4px 6px rgba(0,0,0,0.3), 0 2px 4px rgba(0,0,0,0.2);

      --transition-fast: 150ms ease;
      --transition-normal: 250ms ease;
      --transition-slow: 400ms ease;
    }

    /* ===================================================================
       RESET & BASE
       =================================================================== */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      font-size: 16px;
      scroll-behavior: smooth;
    }

    body {
      font-family: var(--font-sans);
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ===================================================================
       SKIP LINK -- Accessibility
       =================================================================== */
    .skip-link {
      position: absolute;
      top: -50px;
      left: 0;
      background: var(--accent-blue);
      color: var(--bg-primary);
      padding: 8px 16px;
      z-index: 10000;
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
      transition: top var(--transition-fast);
    }

    .skip-link:focus {
      top: 0;
    }

    /* ===================================================================
       FOCUS STYLES -- Accessibility
       =================================================================== */
    *:focus-visible {
      outline: 2px solid var(--border-focus);
      outline-offset: 2px;
    }

    *:focus:not(:focus-visible) {
      outline: none;
    }

    /* ===================================================================
       HEADER
       =================================================================== */
    .app-header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .app-header__title-group {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .app-header__icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .app-header__icon svg {
      width: 36px;
      height: 36px;
    }

    .app-header__title {
      font-size: 1.25rem;
      font-weight: 700;
      letter-spacing: -0.01em;
      color: var(--text-primary);
    }

    .app-header__subtitle {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--accent-blue);
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .app-header__stats {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
      align-items: center;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .stat-item__value {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--accent-cyan);
      font-family: var(--font-mono);
    }

    .stat-item__label {
      font-size: 0.6875rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stats-divider {
      width: 1px;
      height: 32px;
      background: var(--border-color);
    }

    /* ===================================================================
       STATUS INDICATOR
       =================================================================== */
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .status-indicator__dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-green);
      animation: pulse 2s ease-in-out infinite;
    }

    .status-indicator__dot--offline {
      background: var(--accent-red);
      animation: none;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* ===================================================================
       MAIN LAYOUT
       =================================================================== */
    .app-main {
      max-width: 1280px;
      margin: 0 auto;
      padding: 24px 32px 48px;
    }

    /* ===================================================================
       SECTIONS & CARDS
       =================================================================== */
    .section {
      margin-bottom: 24px;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-card);
      overflow: hidden;
      transition: opacity var(--transition-normal);
    }

    .card__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      background: rgba(255,255,255,0.02);
    }

    .card__header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card__header-icon {
      color: var(--accent-blue);
      display: flex;
      align-items: center;
    }

    .card__header-icon svg {
      width: 18px;
      height: 18px;
    }

    .card__title {
      font-size: 0.8125rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-label);
    }

    .card__body {
      padding: 20px;
    }

    /* ===================================================================
       INPUT SECTION
       =================================================================== */
    .input-section .card__body {
      padding: 20px;
    }

    .textarea-label {
      display: block;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .tar-textarea {
      width: 100%;
      min-height: 120px;
      padding: 14px 16px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-family: var(--font-sans);
      font-size: 0.9375rem;
      line-height: 1.6;
      resize: vertical;
      transition: border-color var(--transition-fast);
    }

    .tar-textarea::placeholder {
      color: var(--text-muted);
    }

    .tar-textarea:focus {
      border-color: var(--accent-blue);
      outline: none;
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.15);
    }

    .sample-tars {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .sample-tars__label {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 500;
      white-space: nowrap;
    }

    .sample-tar-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 0.75rem;
      padding: 5px 10px;
      cursor: pointer;
      transition: all var(--transition-fast);
      font-family: var(--font-sans);
      max-width: 280px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .sample-tar-btn:hover {
      background: var(--bg-card-hover);
      border-color: var(--accent-blue);
      color: var(--text-primary);
    }

    .action-buttons {
      margin-top: 16px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border: 1px solid transparent;
      border-radius: var(--radius-md);
      font-family: var(--font-sans);
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      white-space: nowrap;
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn svg {
      width: 16px;
      height: 16px;
    }

    .btn--primary {
      background: var(--accent-blue);
      color: var(--bg-primary);
    }

    .btn--primary:hover:not(:disabled) {
      background: #7dd3fc;
    }

    .btn--primary:active:not(:disabled) {
      background: #0ea5e9;
    }

    .btn--secondary {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
    }

    .btn--secondary:hover:not(:disabled) {
      border-color: var(--accent-blue);
      color: var(--text-primary);
      background: rgba(56, 189, 248, 0.08);
    }

    /* ===================================================================
       SPINNER
       =================================================================== */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    .spinner--large {
      width: 32px;
      height: 32px;
      border-width: 3px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ===================================================================
       EMPTY / LOADING / ERROR STATES
       =================================================================== */
    .state-message {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px 24px;
      gap: 12px;
      text-align: center;
    }

    .state-message__icon {
      color: var(--text-muted);
    }

    .state-message__icon svg {
      width: 40px;
      height: 40px;
    }

    .state-message__text {
      font-size: 0.875rem;
      color: var(--text-muted);
      max-width: 420px;
      line-height: 1.6;
    }

    .state-message--error .state-message__icon {
      color: var(--accent-red);
    }

    .state-message--error .state-message__text {
      color: var(--accent-red);
    }

    .state-message--loading .state-message__icon {
      color: var(--accent-blue);
    }

    /* ===================================================================
       DIAGNOSIS PANEL
       =================================================================== */
    .diagnosis-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .diagnosis-left,
    .diagnosis-right {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .diagnosis-category {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--accent-cyan);
      line-height: 1.3;
    }

    .diagnosis-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .diagnosis-stat {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.03);
      border-radius: var(--radius-md);
      border: 1px solid rgba(255,255,255,0.04);
    }

    .diagnosis-stat__value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      font-family: var(--font-mono);
      line-height: 1.2;
    }

    .diagnosis-stat__label {
      font-size: 0.6875rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    /* Confidence Bar */
    .confidence-bar {
      margin-top: 4px;
    }

    .confidence-bar__header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
    }

    .confidence-bar__label {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .confidence-bar__value {
      font-size: 0.875rem;
      font-weight: 700;
      font-family: var(--font-mono);
    }

    .confidence-bar__track {
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
    }

    .confidence-bar__fill {
      height: 100%;
      border-radius: 4px;
      transition: width var(--transition-slow);
    }

    /* Solution Breakdown */
    .solution-breakdown__title {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-label);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .solution-item {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .solution-item__label {
      width: 100px;
      font-size: 0.8125rem;
      color: var(--text-secondary);
      text-transform: capitalize;
      text-align: right;
      flex-shrink: 0;
    }

    .solution-item__bar-track {
      flex: 1;
      height: 20px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      overflow: hidden;
      position: relative;
    }

    .solution-item__bar-fill {
      height: 100%;
      border-radius: var(--radius-sm);
      transition: width var(--transition-slow);
      min-width: 2px;
    }

    .solution-item__pct {
      width: 48px;
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-label);
      font-family: var(--font-mono);
      text-align: right;
      flex-shrink: 0;
    }

    /* Parts List */
    .parts-list__title {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-label);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .parts-list ul {
      list-style: none;
      padding: 0;
    }

    .parts-list li {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }

    .parts-list li:last-child {
      border-bottom: none;
    }

    .part-number {
      font-family: var(--font-mono);
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--accent-amber);
    }

    .part-failures {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .part-summary {
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-style: italic;
      margin-left: auto;
      max-width: 280px;
      text-align: right;
    }

    /* ===================================================================
       INSIGHT TEXT
       =================================================================== */
    .insight-text {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
    }

    .insight-text__title {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-label);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .insight-text__body {
      font-size: 0.875rem;
      color: var(--text-secondary);
      line-height: 1.7;
    }

    /* ===================================================================
       SIMILAR CASES
       =================================================================== */
    .cases-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .case-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      overflow: hidden;
      transition: border-color var(--transition-fast);
    }

    .case-card:hover {
      border-color: rgba(56, 189, 248, 0.3);
    }

    .case-card__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: rgba(255,255,255,0.02);
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }

    .case-card__header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .similarity-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 700;
      font-family: var(--font-mono);
    }

    .similarity-badge--high {
      background: rgba(52, 211, 153, 0.15);
      color: var(--accent-green);
      border: 1px solid rgba(52, 211, 153, 0.3);
    }

    .similarity-badge--medium {
      background: rgba(56, 189, 248, 0.15);
      color: var(--accent-blue);
      border: 1px solid rgba(56, 189, 248, 0.3);
    }

    .similarity-badge--low {
      background: rgba(251, 191, 36, 0.15);
      color: var(--accent-amber);
      border: 1px solid rgba(251, 191, 36, 0.3);
    }

    .case-jcn {
      font-family: var(--font-mono);
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .case-cluster-label {
      font-size: 0.6875rem;
      color: var(--text-muted);
      padding: 2px 8px;
      background: rgba(255,255,255,0.05);
      border-radius: var(--radius-sm);
    }

    .case-card__body {
      padding: 12px 16px;
    }

    .case-subject {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .case-issue {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 12px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .maf-actions {
      border-top: 1px solid rgba(255,255,255,0.04);
      padding-top: 10px;
    }

    .maf-actions__title {
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .maf-action {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 12px;
      align-items: start;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,0.03);
      font-size: 0.8125rem;
    }

    .maf-action:last-child {
      border-bottom: none;
    }

    .maf-action__text {
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .maf-action__hours {
      font-family: var(--font-mono);
      font-size: 0.75rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .maf-action__parts {
      font-family: var(--font-mono);
      font-size: 0.6875rem;
      color: var(--accent-amber);
      white-space: nowrap;
    }

    .show-more-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      width: 100%;
      padding: 10px;
      margin-top: 12px;
      background: transparent;
      border: 1px dashed var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-muted);
      font-size: 0.8125rem;
      font-family: var(--font-sans);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .show-more-btn:hover {
      border-color: var(--accent-blue);
      color: var(--text-secondary);
      background: rgba(56, 189, 248, 0.04);
    }

    /* ===================================================================
       AI RECOMMENDATION
       =================================================================== */
    .recommendation-text {
      font-size: 0.9375rem;
      color: var(--text-primary);
      line-height: 1.8;
      white-space: pre-wrap;
    }

    /* ===================================================================
       FOOTER
       =================================================================== */
    .app-footer {
      border-top: 1px solid var(--border-color);
      padding: 20px 32px;
      text-align: center;
    }

    .footer-powered {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .footer-tech {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tech-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius-sm);
      font-size: 0.6875rem;
      font-family: var(--font-mono);
      color: var(--text-muted);
    }

    .footer-separator {
      color: var(--text-muted);
      font-size: 0.6875rem;
    }

    .footer-classification {
      margin-top: 8px;
      font-size: 0.6875rem;
      color: var(--text-muted);
    }

    /* ===================================================================
       TAR QUEUE
       =================================================================== */
    .tar-queue__filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
      align-items: center;
    }

    .tar-queue__search {
      flex: 1 1 200px;
      min-width: 180px;
      padding: 8px 12px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-family: var(--font-sans);
      font-size: 0.8125rem;
      transition: border-color var(--transition-fast);
    }

    .tar-queue__search::placeholder { color: var(--text-muted); }
    .tar-queue__search:focus { border-color: var(--accent-blue); outline: none; box-shadow: 0 0 0 2px rgba(56,189,248,0.15); }

    .tar-queue__select {
      padding: 8px 10px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-family: var(--font-sans);
      font-size: 0.75rem;
      cursor: pointer;
      min-width: 120px;
    }

    .tar-queue__select:focus { border-color: var(--accent-blue); outline: none; }

    .tar-queue__clear-btn {
      padding: 8px 12px;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      font-family: var(--font-sans);
      font-size: 0.75rem;
      cursor: pointer;
      transition: all var(--transition-fast);
      white-space: nowrap;
    }

    .tar-queue__clear-btn:hover { border-color: var(--accent-blue); color: var(--text-secondary); }

    .tar-queue__table-wrap {
      max-height: 310px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
    }

    .tar-queue__table-wrap::-webkit-scrollbar { width: 6px; }
    .tar-queue__table-wrap::-webkit-scrollbar-track { background: var(--bg-primary); }
    .tar-queue__table-wrap::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 3px; }

    .tar-queue__table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8125rem;
      table-layout: fixed;
    }

    .tar-queue__table thead {
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .tar-queue__table th {
      padding: 8px 10px;
      text-align: left;
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
      white-space: nowrap;
    }

    .tar-queue__table td {
      padding: 7px 10px;
      border-bottom: 1px solid rgba(51,65,85,0.5);
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .tar-queue__table td.tq-subject {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 0;
    }

    .tar-queue__table td.tq-system {
      max-width: 160px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .tar-queue__row {
      cursor: pointer;
      transition: background var(--transition-fast);
      height: 36px;
    }

    .tar-queue__row:nth-child(even) { background: rgba(255,255,255,0.015); }
    .tar-queue__row:hover { background: var(--bg-card-hover); }

    .tar-queue__row--selected {
      background: rgba(56,189,248,0.08) !important;
      border-left: 3px solid var(--accent-blue);
    }

    .tar-queue__row--selected td:first-child { padding-left: 7px; }

    .tq-jcn { font-family: var(--font-mono); color: var(--text-label); font-size: 0.75rem; }
    .tq-date { font-size: 0.75rem; color: var(--text-muted); }

    .tq-priority-indicator {
      display: inline-block;
      width: 7px;
      height: 7px;
      border-radius: 50%;
      margin-right: 4px;
      vertical-align: middle;
    }

    .tq-priority--urgent { background: var(--accent-red); }
    .tq-priority--priority { background: var(--accent-amber); }

    .tar-queue__footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .tar-queue__load-more {
      padding: 6px 14px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-family: var(--font-sans);
      font-size: 0.75rem;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .tar-queue__load-more:hover { border-color: var(--accent-blue); color: var(--text-primary); }

    .tar-queue__spinner {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px;
      color: var(--text-muted);
      font-size: 0.8125rem;
      gap: 10px;
    }

    /* ===================================================================
       HIDDEN (Utility)
       =================================================================== */
    .hidden {
      display: none;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border: 0;
    }

    /* ===================================================================
       RESPONSIVE
       =================================================================== */
    @media (max-width: 900px) {
      .app-header {
        padding: 12px 16px;
      }

      .app-header__stats {
        gap: 12px;
      }

      .stats-divider {
        display: none;
      }

      .app-main {
        padding: 16px;
      }

      .diagnosis-grid {
        grid-template-columns: 1fr;
      }

      .diagnosis-stats {
        grid-template-columns: repeat(3, 1fr);
      }

      .maf-action {
        grid-template-columns: 1fr;
        gap: 4px;
      }
    }

    @media (max-width: 600px) {
      .app-header__stats {
        display: none;
      }

      .diagnosis-stats {
        grid-template-columns: 1fr 1fr;
      }

      .sample-tar-btn {
        max-width: 200px;
      }
    }

    /* ===================================================================
       REDUCED MOTION
       =================================================================== */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }

      html {
        scroll-behavior: auto;
      }
    }

    /* ===================================================================
       TAB NAVIGATION
       =================================================================== */
    .tab-nav {
      display: flex;
      gap: 0;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 0 32px;
    }

    .tab-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border: none;
      border-bottom: 2px solid transparent;
      background: transparent;
      color: var(--text-muted);
      font-family: var(--font-sans);
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      white-space: nowrap;
    }

    .tab-btn svg {
      width: 16px;
      height: 16px;
    }

    .tab-btn:hover {
      color: var(--text-secondary);
      background: rgba(255,255,255,0.03);
    }

    .tab-btn--active {
      color: var(--accent-blue);
      border-bottom-color: var(--accent-blue);
    }

    .btn--small {
      padding: 6px 14px;
      font-size: 0.75rem;
    }

    /* ===================================================================
       TPDR CANDIDATE CARDS
       =================================================================== */
    .tpdr-candidate {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 20px;
      margin-bottom: 16px;
      transition: border-color var(--transition-fast);
    }

    .tpdr-candidate:hover {
      border-color: var(--accent-blue);
    }

    .tpdr-candidate__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tpdr-candidate__rank {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .tpdr-candidate__rank-num {
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--text-muted);
      font-family: var(--font-mono);
    }

    .tpdr-score-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 700;
      font-family: var(--font-mono);
      background: rgba(56, 189, 248, 0.15);
      color: var(--accent-blue);
      border: 1px solid rgba(56, 189, 248, 0.3);
    }

    .tpdr-candidate__title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
    }

    .tpdr-stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .tpdr-stat-box {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 12px;
      text-align: center;
    }

    .tpdr-stat-box__value {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--accent-cyan);
      font-family: var(--font-mono);
      line-height: 1.2;
    }

    .tpdr-stat-box__label {
      font-size: 0.6875rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 4px;
    }

    .tpdr-sparkline-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .tpdr-sparkline-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .tpdr-justification {
      background: var(--bg-secondary);
      border-left: 3px solid var(--accent-blue);
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      padding: 12px 16px;
      margin-bottom: 12px;
    }

    .tpdr-justification__label {
      font-size: 0.6875rem;
      font-weight: 600;
      color: var(--accent-blue);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 6px;
    }

    .tpdr-justification__text {
      font-size: 0.875rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .tpdr-details-toggle {
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 0.8125rem;
      font-weight: 500;
      padding: 8px 16px;
      cursor: pointer;
      transition: all var(--transition-fast);
      font-family: var(--font-sans);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .tpdr-details-toggle:hover {
      border-color: var(--accent-blue);
      color: var(--text-primary);
    }

    /* Detail View (expandable) */
    .tpdr-detail {
      margin-top: 16px;
      border-top: 1px solid var(--border-color);
      padding-top: 16px;
    }

    .tpdr-detail__section {
      margin-bottom: 16px;
    }

    .tpdr-detail__section-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-label);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 8px;
    }

    .tpdr-bar-chart {
      display: flex;
      align-items: flex-end;
      gap: 3px;
      height: 80px;
      padding: 4px 0;
    }

    .tpdr-bar {
      flex: 1;
      border-radius: 2px 2px 0 0;
      min-width: 4px;
      transition: height var(--transition-normal);
      position: relative;
    }

    .tpdr-bar-labels {
      display: flex;
      gap: 3px;
      margin-top: 4px;
    }

    .tpdr-bar-label {
      flex: 1;
      text-align: center;
      font-size: 0.5rem;
      color: var(--text-muted);
      font-family: var(--font-mono);
    }

    .tpdr-aircraft-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tpdr-aircraft-badge {
      display: inline-flex;
      padding: 3px 8px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius-sm);
      font-size: 0.6875rem;
      font-family: var(--font-mono);
      color: var(--text-secondary);
    }

    .tpdr-comeback-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8125rem;
    }

    .tpdr-comeback-table th {
      text-align: left;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.6875rem;
      padding: 6px 8px;
      border-bottom: 1px solid var(--border-color);
    }

    .tpdr-comeback-table td {
      padding: 6px 8px;
      color: var(--text-secondary);
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }

    /* Fleet Trend Overview */
    .tpdr-trend-section {
      margin-bottom: 20px;
    }

    .tpdr-trend-section__title {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-label);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .tpdr-trend-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      margin-bottom: 4px;
      transition: background var(--transition-fast);
    }

    .tpdr-trend-item:hover {
      background: rgba(255,255,255,0.03);
    }

    .tpdr-trend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .tpdr-trend-dot--critical { background: var(--accent-red); }
    .tpdr-trend-dot--moderate { background: var(--accent-amber); }
    .tpdr-trend-dot--stable { background: var(--text-muted); }
    .tpdr-trend-dot--declining { background: var(--accent-green); }

    .tpdr-trend-name {
      flex: 1;
      font-size: 0.8125rem;
      color: var(--text-secondary);
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .tpdr-trend-ratio {
      font-size: 0.8125rem;
      font-weight: 700;
      font-family: var(--font-mono);
      min-width: 50px;
      text-align: right;
    }

    .tpdr-trend-ratio--critical { color: var(--accent-red); }
    .tpdr-trend-ratio--moderate { color: var(--accent-amber); }
    .tpdr-trend-ratio--stable { color: var(--text-muted); }
    .tpdr-trend-ratio--declining { color: var(--accent-green); }

    /* Responsive -- TPDR */
    @media (max-width: 900px) {
      .tpdr-stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .tab-nav {
        padding: 0 16px;
      }
    }

    @media (max-width: 600px) {
      .tpdr-stats-grid {
        grid-template-columns: 1fr 1fr;
      }
      .tab-btn {
        font-size: 0.8125rem;
        padding: 10px 14px;
      }
    }
    /* ===================================================================
       FLEET ANALYTICS TAB
       =================================================================== */
    .fleet-stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .fleet-stat-box {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 16px;
      text-align: center;
    }

    .fleet-stat-box__value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent-cyan);
      font-family: var(--font-mono);
      line-height: 1.2;
    }

    .fleet-stat-box__label {
      font-size: 0.6875rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 4px;
    }

    .fleet-bar-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: var(--radius-sm);
      transition: background var(--transition-fast);
    }

    .fleet-bar-row:hover {
      background: rgba(255,255,255,0.03);
    }

    .fleet-bar-row__label {
      width: 280px;
      font-size: 0.8125rem;
      color: var(--text-secondary);
      flex-shrink: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .fleet-bar-row__track {
      flex: 1;
      height: 24px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      overflow: hidden;
      position: relative;
    }

    .fleet-bar-row__fill {
      height: 100%;
      border-radius: var(--radius-sm);
      transition: width var(--transition-slow);
      min-width: 2px;
    }

    .fleet-bar-row__value {
      width: 64px;
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-label);
      font-family: var(--font-mono);
      text-align: right;
      flex-shrink: 0;
    }

    .fleet-detail {
      margin: 4px 0 16px 12px;
      border-left: 3px solid var(--accent-blue);
      padding: 16px 20px;
      background: var(--bg-tertiary);
      border-radius: 0 var(--radius-md) var(--radius-md) 0;
    }

    .fleet-detail__grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .fleet-detail__section {
      margin-bottom: 16px;
    }

    .fleet-detail__section:last-child {
      margin-bottom: 0;
    }

    .fleet-detail__section-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-label);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 8px;
    }

    .fleet-insight-box {
      background: var(--bg-secondary);
      border-left: 3px solid var(--accent-purple);
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      padding: 12px 16px;
      margin-top: 16px;
    }

    .fleet-insight-box__label {
      font-size: 0.6875rem;
      font-weight: 600;
      color: var(--accent-purple);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 6px;
    }

    .fleet-insight-box__text {
      font-size: 0.875rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .fleet-parts-badge {
      display: inline-flex;
      padding: 3px 8px;
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid rgba(251, 191, 36, 0.25);
      border-radius: var(--radius-sm);
      font-size: 0.6875rem;
      font-family: var(--font-mono);
      color: var(--accent-amber);
    }

    .fleet-jcn-list {
      list-style: none;
      padding: 0;
    }

    .fleet-jcn-list li {
      font-family: var(--font-mono);
      font-size: 0.75rem;
      color: var(--accent-cyan);
      padding: 2px 0;
    }

    @media (max-width: 900px) {
      .fleet-stats-row {
        grid-template-columns: repeat(2, 1fr);
      }
      .fleet-bar-row__label {
        width: 180px;
      }
      .fleet-detail__grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 600px) {
      .fleet-stats-row {
        grid-template-columns: 1fr 1fr;
      }
      .fleet-bar-row__label {
        width: 120px;
        font-size: 0.75rem;
      }
    }

    /* ===================================================================
       EXTRACTED SOLUTIONS TABLE (Fleet Analytics)
       =================================================================== */
    .extracted-solutions-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8125rem;
    }

    .extracted-solutions-table th {
      text-align: left;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.6875rem;
      padding: 6px 8px;
      border-bottom: 1px solid var(--border-color);
    }

    .extracted-solutions-table td {
      padding: 5px 8px;
      color: var(--text-secondary);
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }

    /* ===================================================================
       FLAG BUTTON (TAR Lookup)
       =================================================================== */
    .flag-btn {
      background: transparent;
      border: 1px solid transparent;
      color: var(--text-muted);
      font-size: 0.6875rem;
      font-family: var(--font-sans);
      padding: 3px 8px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
      white-space: nowrap;
    }
    .flag-btn:hover {
      color: var(--accent-amber);
      border-color: rgba(251, 191, 36, 0.3);
      background: rgba(251, 191, 36, 0.08);
    }
    .flag-btn--flagged {
      color: var(--text-muted);
      opacity: 0.6;
      cursor: default;
      pointer-events: none;
    }
    .case-card--flagged {
      opacity: 0.5;
    }
    .flag-counter {
      font-size: 0.75rem;
      color: var(--accent-amber);
      font-family: var(--font-mono);
      margin-left: 8px;
    }

    /* ===================================================================
       TPDR WORKFLOW
       =================================================================== */
    .tpdr-workflow-btn {
      background: transparent;
      border: 1px solid;
      font-size: 0.6875rem;
      font-family: var(--font-sans);
      font-weight: 600;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    .tpdr-workflow-btn--file {
      color: var(--accent-green);
      border-color: rgba(52, 211, 153, 0.3);
    }
    .tpdr-workflow-btn--file:hover {
      background: rgba(52, 211, 153, 0.12);
      border-color: var(--accent-green);
    }
    .tpdr-workflow-btn--defer {
      color: var(--accent-amber);
      border-color: rgba(251, 191, 36, 0.3);
    }
    .tpdr-workflow-btn--defer:hover {
      background: rgba(251, 191, 36, 0.12);
      border-color: var(--accent-amber);
    }
    .tpdr-state-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      border-radius: var(--radius-sm);
      font-size: 0.6875rem;
      font-weight: 700;
    }
    .tpdr-state-badge--filed {
      background: rgba(52, 211, 153, 0.15);
      color: var(--accent-green);
      border: 1px solid rgba(52, 211, 153, 0.3);
    }
    .tpdr-state-badge--deferred {
      background: rgba(251, 191, 36, 0.15);
      color: var(--accent-amber);
      border: 1px solid rgba(251, 191, 36, 0.3);
    }
    .tpdr-undo-link {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 0.6875rem;
      font-family: var(--font-sans);
      cursor: pointer;
      text-decoration: underline;
      padding: 2px 4px;
      transition: color var(--transition-fast);
    }
    .tpdr-undo-link:hover {
      color: var(--text-secondary);
    }
    .tpdr-candidate--deferred {
      opacity: 0.65;
      border-left: 3px solid var(--accent-amber);
    }
    .tpdr-candidate--filed {
      opacity: 0.7;
      border-left: 3px solid var(--accent-green);
      padding: 12px 20px;
    }
    .tpdr-section-header {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-label);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin: 24px 0 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tpdr-section-header--filed {
      color: var(--accent-green);
    }
    .tpdr-section-header--deferred {
      color: var(--accent-amber);
    }
    .tpdr-stats-bar {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      margin-bottom: 16px;
      font-size: 0.8125rem;
      color: var(--text-secondary);
      font-family: var(--font-mono);
    }
    .tpdr-stats-bar span {
      color: var(--accent-cyan);
      font-weight: 700;
    }
    .tpdr-defer-input {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      padding: 8px 12px;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
    }
    .tpdr-defer-input input {
      flex: 1;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-family: var(--font-sans);
      font-size: 0.8125rem;
      padding: 6px 10px;
    }
    .tpdr-defer-input input:focus {
      border-color: var(--accent-amber);
      outline: none;
    }
    .tpdr-defer-input button {
      background: var(--accent-amber);
      color: var(--bg-primary);
      border: none;
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 600;
      padding: 6px 12px;
      cursor: pointer;
      font-family: var(--font-sans);
    }

    /* ===================================================================
       TPDR THRESHOLD PANEL
       =================================================================== */
    .threshold-panel {
      margin-bottom: 20px;
    }
    .threshold-toggle {
      background: transparent;
      border: 1px dashed var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 0.8125rem;
      font-weight: 500;
      padding: 10px 16px;
      cursor: pointer;
      transition: all var(--transition-fast);
      font-family: var(--font-sans);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 12px;
    }
    .threshold-toggle:hover {
      border-color: var(--accent-blue);
      color: var(--text-primary);
    }
    .threshold-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 12px;
    }
    .threshold-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .threshold-field label {
      font-size: 0.6875rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .threshold-field input,
    .threshold-field select {
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-family: var(--font-mono);
      font-size: 0.875rem;
      padding: 8px 10px;
      width: 100%;
    }
    .threshold-field input:focus,
    .threshold-field select:focus {
      border-color: var(--accent-blue);
      outline: none;
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.15);
    }
    .threshold-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 8px;
    }
    .threshold-count {
      font-size: 0.8125rem;
      color: var(--text-secondary);
    }
    .threshold-count span {
      color: var(--accent-cyan);
      font-weight: 600;
      font-family: var(--font-mono);
    }
    .threshold-multiselect {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }
    .threshold-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: 0.6875rem;
      font-family: var(--font-mono);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--transition-fast);
      user-select: none;
    }
    .threshold-chip:hover {
      border-color: var(--accent-blue);
      color: var(--text-primary);
    }
    .threshold-chip--active {
      background: rgba(56, 189, 248, 0.12);
      border-color: var(--accent-blue);
      color: var(--accent-blue);
    }
    .threshold-multiselect-label {
      font-size: 0.6875rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-top: 12px;
      margin-bottom: 4px;
    }
    .threshold-multiselect-actions {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }
    .threshold-link-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 0.6875rem;
      font-family: var(--font-sans);
      cursor: pointer;
      text-decoration: underline;
      padding: 2px 4px;
      transition: color var(--transition-fast);
    }
    .threshold-link-btn:hover {
      color: var(--text-secondary);
    }
    .threshold-summary {
      font-size: 0.8125rem;
      color: var(--text-muted);
      line-height: 1.6;
      margin-bottom: 14px;
    }
    .threshold-summary .tv {
      font-family: var(--font-mono);
      color: var(--accent-cyan);
      font-weight: 600;
    }
    .threshold-tip {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 14px;
      height: 14px;
      font-size: 0.5625rem;
      font-weight: 700;
      color: var(--text-muted);
      border: 1px solid var(--border-color);
      border-radius: 50%;
      cursor: help;
      margin-left: 4px;
      vertical-align: middle;
      flex-shrink: 0;
    }
    .threshold-tip .threshold-tiptext {
      visibility: hidden;
      opacity: 0;
      position: absolute;
      bottom: calc(100% + 6px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 0.6875rem;
      font-weight: 400;
      white-space: nowrap;
      padding: 4px 8px;
      pointer-events: none;
      transition: opacity 0.15s;
      z-index: 10;
    }
    .threshold-tip:hover .threshold-tiptext {
      visibility: visible;
      opacity: 1;
    }
    .threshold-field label {
      display: flex;
      align-items: center;
    }
    @media (max-width: 900px) {
      .threshold-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px) {
      .threshold-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Skip link for keyboard navigation -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- ================================================================
       HEADER
       ================================================================ -->
  <header class="app-header" role="banner">
    <div class="app-header__title-group">
      <div class="app-header__icon" aria-hidden="true">
        <svg viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="2" y="2" width="32" height="32" rx="6" stroke="#38bdf8" stroke-width="2"/>
          <path d="M10 18h16M18 10v16M12 12l12 12M24 12L12 24" stroke="#38bdf8" stroke-width="1.5" stroke-linecap="round" opacity="0.3"/>
          <circle cx="18" cy="18" r="5" stroke="#22d3ee" stroke-width="2"/>
          <circle cx="18" cy="18" r="1.5" fill="#22d3ee"/>
        </svg>
      </div>
      <div>
        <div class="app-header__title">V-22 TAR Intelligence System</div>
        <div class="app-header__subtitle">Maintenance Decision Support</div>
      </div>
    </div>

    <div class="app-header__stats" id="headerStats" role="status" aria-label="Database statistics">
      <div class="stat-item">
        <span class="stat-item__value" id="statTars">--</span>
        <span class="stat-item__label">TARs Indexed</span>
      </div>
      <div class="stats-divider" aria-hidden="true"></div>
      <div class="stat-item">
        <span class="stat-item__value" id="statMafs">--</span>
        <span class="stat-item__label">Maintenance Records</span>
      </div>
      <div class="stats-divider" aria-hidden="true"></div>
      <div class="stat-item">
        <span class="stat-item__value" id="statClusters">--</span>
        <span class="stat-item__label">Problem Categories</span>
      </div>
      <div class="stats-divider" aria-hidden="true"></div>
      <div class="stat-item">
        <span class="stat-item__value" id="statParts">--</span>
        <span class="stat-item__label">Parts Tracked</span>
      </div>
      <div class="stats-divider" aria-hidden="true"></div>
      <div class="status-indicator">
        <span class="status-indicator__dot" id="statusDot" aria-hidden="true"></span>
        <span id="statusText">Connecting...</span>
      </div>
    </div>
  </header>

  <!-- TAB NAVIGATION -->
  <nav class="tab-nav" role="tablist" aria-label="Application views">
    <button class="tab-btn" id="tabBtnFleet" role="tab" aria-selected="false" aria-controls="tabFleetAnalytics">
      <svg viewBox="0 0 16 16" fill="none" aria-hidden="true"><rect x="1" y="9" width="3" height="6" rx="0.5" fill="currentColor" opacity="0.6"/><rect x="5.5" y="5" width="3" height="10" rx="0.5" fill="currentColor" opacity="0.8"/><rect x="10" y="2" width="3" height="13" rx="0.5" fill="currentColor"/></svg>
      Fleet Analytics
    </button>
    <button class="tab-btn tab-btn--active" id="tabBtnLookup" role="tab" aria-selected="true" aria-controls="tabLookup">
      <svg viewBox="0 0 16 16" fill="none" aria-hidden="true"><circle cx="7" cy="7" r="5.5" stroke="currentColor" stroke-width="2"/><path d="M11.5 11.5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      TAR Lookup
    </button>
    <button class="tab-btn" id="tabBtnTPDR" role="tab" aria-selected="false" aria-controls="tabTPDR">
      <svg viewBox="0 0 16 16" fill="none" aria-hidden="true"><path d="M2 12l4-8 3 4 2-3 3 7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      TPDR Intelligence
    </button>
  </nav>

  <!-- ================================================================
       MAIN CONTENT
       ================================================================ -->
  <main id="main-content" class="app-main" tabindex="-1">

    <div id="tabFleetAnalytics" class="hidden" role="tabpanel" aria-labelledby="tabBtnFleet">
      <section class="section" aria-labelledby="fleet-overview-heading">
        <div class="card">
          <div class="card__header">
            <div class="card__header-left">
              <span class="card__header-icon" aria-hidden="true">
                <svg viewBox="0 0 18 18" fill="none"><rect x="1" y="10" width="3.5" height="7" rx="0.5" stroke="currentColor" stroke-width="1.5"/><rect x="7.25" y="5" width="3.5" height="12" rx="0.5" stroke="currentColor" stroke-width="1.5"/><rect x="13.5" y="1" width="3.5" height="16" rx="0.5" stroke="currentColor" stroke-width="1.5"/></svg>
              </span>
              <h2 class="card__title" id="fleet-overview-heading">Fleet Analytics</h2>
            </div>
          </div>
          <div class="card__body" id="fleetBody">
            <div class="state-message state-message--loading" id="fleetLoading">
              <div class="state-message__icon"><div class="spinner spinner--large" role="status"><span class="sr-only">Loading fleet analytics</span></div></div>
              <p class="state-message__text">Loading fleet analytics data...</p>
            </div>
            <div class="hidden" id="fleetError">
              <div class="state-message state-message--error" role="alert">
                <p class="state-message__text" id="fleetErrorText">Failed to load fleet analytics data.</p>
              </div>
            </div>
            <div class="hidden" id="fleetResults">
              <div id="fleetStatsRow" class="fleet-stats-row"></div>

              <div class="fleet-detail__section">
                <div class="fleet-detail__section-title" style="font-size: 0.875rem; margin-bottom: 16px;">Problem Categories</div>
                <div id="fleetClustersChart"></div>
              </div>

              <div class="fleet-detail__section" style="margin-top: 32px;">
                <div class="fleet-detail__section-title" style="font-size: 0.875rem; margin-bottom: 16px;">Top Failing Parts</div>
                <div id="fleetPartsChart"></div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div><!-- tabFleetAnalytics -->

    <div id="tabLookup" role="tabpanel" aria-labelledby="tabBtnLookup">

    <!-- TAR QUEUE SECTION -->
    <section class="section" aria-labelledby="tar-queue-heading">
      <div class="card">
        <div class="card__header">
          <div class="card__header-left">
            <span class="card__header-icon" aria-hidden="true">
              <svg viewBox="0 0 18 18" fill="none"><rect x="2" y="3" width="14" height="2" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="2" y="8" width="14" height="2" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="2" y="13" width="14" height="2" rx="1" stroke="currentColor" stroke-width="1.5"/></svg>
            </span>
            <h2 class="card__title" id="tar-queue-heading">TAR Queue</h2>
          </div>
          <span id="tarQueueCount" class="tech-badge hidden" aria-live="polite"></span>
        </div>
        <div class="card__body" id="tarQueueBody">
          <div id="tarQueueLoading" class="tar-queue__spinner">
            <span class="spinner" role="status"><span class="sr-only">Loading TAR queue</span></span>
            Loading recent TARs...
          </div>
          <div id="tarQueueContent" class="hidden">
            <div class="tar-queue__filters">
              <input type="text" id="tarQueueSearch" class="tar-queue__search" placeholder="Search TARs..." aria-label="Search TARs by subject or issue">
              <select id="tarQueueWorkCenter" class="tar-queue__select" aria-label="Filter by work center">
                <option value="">All Work Centers</option>
              </select>
              <select id="tarQueueActivity" class="tar-queue__select" aria-label="Filter by activity">
                <option value="">All Activities</option>
              </select>
              <select id="tarQueuePriority" class="tar-queue__select" aria-label="Filter by priority">
                <option value="">All Priorities</option>
              </select>
              <button type="button" id="tarQueueClearBtn" class="tar-queue__clear-btn">Clear Filters</button>
            </div>
            <div class="tar-queue__table-wrap">
              <table class="tar-queue__table" aria-label="Recent TARs">
                <thead>
                  <tr>
                    <th style="width:100px">JCN</th>
                    <th style="width:90px">Date</th>
                    <th style="width:80px">Priority</th>
                    <th style="width:160px">System</th>
                    <th>Subject</th>
                  </tr>
                </thead>
                <tbody id="tarQueueTableBody"></tbody>
              </table>
            </div>
            <div class="tar-queue__footer">
              <span id="tarQueueShowing"></span>
              <button type="button" id="tarQueueLoadMore" class="tar-queue__load-more hidden">Load More</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- INPUT SECTION -->
    <section class="section input-section" aria-labelledby="input-heading">
      <div class="card">
        <div class="card__header">
          <div class="card__header-left">
            <span class="card__header-icon" aria-hidden="true">
              <svg viewBox="0 0 18 18" fill="none"><path d="M9 1.5v15M1.5 9h15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </span>
            <h2 class="card__title" id="input-heading">TAR Input</h2>
          </div>
        </div>
        <div class="card__body">
          <label for="tarInput" class="textarea-label">Enter TAR description or paste a Technical Assistance Request for analysis</label>
          <textarea
            id="tarInput"
            class="tar-textarea"
            placeholder="Describe the maintenance issue, fault, or discrepancy. Include details such as component, symptom, and when the issue was observed..."
            rows="5"
            aria-describedby="tarInputHelp"
          ></textarea>
          <div id="tarInputHelp" class="sr-only">
            Enter a TAR description to search historical maintenance data. You can also select a sample TAR below to auto-fill. Press Ctrl+Enter or Cmd+Enter to search.
          </div>

          <div class="sample-tars">
            <span class="sample-tars__label">Sample TARs:</span>
            <button
              type="button"
              class="sample-tar-btn"
              data-tar="FADEC channel A fault during ground turn, posted F(P) three times on download. LH engine slow to respond to throttle inputs."
              aria-label="Load sample: FADEC channel A fault"
            >FADEC Channel A Fault</button>
            <button
              type="button"
              class="sample-tar-btn"
              data-tar="Water intrusion discovered in LH wing root area during phase inspection. Standing water approximately 2 inches deep in lower cavity."
              aria-label="Load sample: Water intrusion in wing root"
            >Water Intrusion - Wing Root</button>
            <button
              type="button"
              class="sample-tar-btn"
              data-tar="RH proprotor gearbox chip detector illuminated during flight. Debris found on mag plug during post-flight inspection."
              aria-label="Load sample: Gearbox chip detector"
            >Gearbox Chip Detector</button>
          </div>

          <div class="action-buttons">
            <button type="button" class="btn btn--primary" id="btnSearch" aria-describedby="searchDesc">
              <svg viewBox="0 0 16 16" fill="none" aria-hidden="true"><circle cx="7" cy="7" r="5.5" stroke="currentColor" stroke-width="2"/><path d="M11.5 11.5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
              Search Historical Data
            </button>
            <span id="searchDesc" class="sr-only">Searches 15,000+ historical TARs and maintenance records for similar cases</span>

          </div>
        </div>
      </div>
    </section>

    <!-- DIAGNOSIS SECTION -->
    <section class="section" aria-labelledby="diagnosis-heading" id="diagnosisSection">
      <div class="card" id="diagnosisCard">
        <div class="card__header">
          <div class="card__header-left">
            <span class="card__header-icon" aria-hidden="true">
              <svg viewBox="0 0 18 18" fill="none"><path d="M9 1.5L16.5 16.5H1.5L9 1.5z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><path d="M9 7v3.5M9 13v.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
            </span>
            <h2 class="card__title" id="diagnosis-heading">Diagnosis</h2>
          </div>
          <span id="diagnosisTimer" class="tech-badge hidden" aria-live="polite"></span>
        </div>
        <div class="card__body" id="diagnosisBody">
          <div class="state-message" id="diagnosisEmpty">
            <div class="state-message__icon" aria-hidden="true">
              <svg viewBox="0 0 40 40" fill="none"><rect x="4" y="4" width="32" height="32" rx="6" stroke="currentColor" stroke-width="2"/><path d="M14 20h12M20 14v12" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity="0.5"/></svg>
            </div>
            <p class="state-message__text">Enter a TAR description above and search to see diagnosis results based on historical maintenance data.</p>
          </div>
          <div class="hidden" id="diagnosisLoading">
            <div class="state-message state-message--loading">
              <div class="state-message__icon"><div class="spinner spinner--large" role="status"><span class="sr-only">Searching historical database</span></div></div>
              <p class="state-message__text">Analyzing TAR against historical database...</p>
            </div>
          </div>
          <div class="hidden" id="diagnosisError">
            <div class="state-message state-message--error" role="alert">
              <div class="state-message__icon" aria-hidden="true">
                <svg viewBox="0 0 40 40" fill="none"><circle cx="20" cy="20" r="16" stroke="currentColor" stroke-width="2"/><path d="M14 14l12 12M26 14L14 26" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
              </div>
              <p class="state-message__text" id="diagnosisErrorText">An error occurred during search.</p>
            </div>
          </div>
          <div class="hidden" id="diagnosisResults" role="region" aria-label="Diagnosis results"></div>
        </div>
      </div>
    </section>

    <!-- SIMILAR CASES SECTION -->
    <section class="section" aria-labelledby="cases-heading" id="casesSection">
      <div class="card" id="casesCard">
        <div class="card__header">
          <div class="card__header-left">
            <span class="card__header-icon" aria-hidden="true">
              <svg viewBox="0 0 18 18" fill="none"><rect x="2" y="2" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="10" y="2" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="2" y="10" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="10" y="10" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/></svg>
            </span>
            <h2 class="card__title" id="cases-heading">Similar Past Cases</h2>
          </div>
          <span id="casesCount" class="tech-badge hidden" aria-live="polite"></span>
        </div>
        <div class="card__body" id="casesBody">
          <div class="state-message" id="casesEmpty">
            <div class="state-message__icon" aria-hidden="true">
              <svg viewBox="0 0 40 40" fill="none"><rect x="4" y="4" width="32" height="14" rx="4" stroke="currentColor" stroke-width="2" opacity="0.5"/><rect x="4" y="22" width="32" height="14" rx="4" stroke="currentColor" stroke-width="2" opacity="0.3"/></svg>
            </div>
            <p class="state-message__text">Similar historical cases will appear here after searching.</p>
          </div>
          <div class="hidden" id="casesResults"></div>
        </div>
      </div>
    </section>

    <!-- AI RECOMMENDATION SECTION -->
    <section class="section" aria-labelledby="recommendation-heading" id="recommendSection">
      <div class="card" id="recommendCard">
        <div class="card__header">
          <div class="card__header-left">
            <span class="card__header-icon" aria-hidden="true">
              <svg viewBox="0 0 18 18" fill="none"><path d="M9 1v2M9 15v2M1 9h2M15 9h2M3.05 3.05l1.41 1.41M13.54 13.54l1.41 1.41M3.05 14.95l1.41-1.41M13.54 4.46l1.41-1.41" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><circle cx="9" cy="9" r="4" stroke="currentColor" stroke-width="1.5"/></svg>
            </span>
            <h2 class="card__title" id="recommendation-heading">AI Recommendation</h2>
          </div>
          <span id="recommendTimer" class="tech-badge hidden" aria-live="polite"></span>
        </div>
        <div class="card__body" id="recommendBody">
          <div class="state-message" id="recommendEmpty">
            <div class="state-message__icon" aria-hidden="true">
              <svg viewBox="0 0 40 40" fill="none"><circle cx="20" cy="20" r="16" stroke="currentColor" stroke-width="2" opacity="0.3"/><path d="M20 12v8M20 24v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity="0.5"/></svg>
            </div>
            <p class="state-message__text">AI recommendation will generate automatically after search completes. This typically takes 10-15 seconds.</p>
          </div>
          <div class="hidden" id="recommendLoading">
            <div class="state-message state-message--loading">
              <div class="state-message__icon"><div class="spinner spinner--large" role="status"><span class="sr-only">Generating AI recommendation</span></div></div>
              <p class="state-message__text" id="recommendLoadingText">Generating AI recommendation via local LLM...</p>
            </div>
          </div>
          <div class="hidden" id="recommendError">
            <div class="state-message state-message--error" role="alert">
              <div class="state-message__icon" aria-hidden="true">
                <svg viewBox="0 0 40 40" fill="none"><circle cx="20" cy="20" r="16" stroke="currentColor" stroke-width="2"/><path d="M14 14l12 12M26 14L14 26" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
              </div>
              <p class="state-message__text"><span id="recommendErrorText">Failed to generate recommendation.</span> <a href="#" id="recommendRetry" style="color:var(--accent-blue);text-decoration:underline;cursor:pointer;margin-left:6px">Retry</a></p>
            </div>
          </div>
          <div class="hidden" id="recommendResults" role="region" aria-label="AI recommendation"></div>
        </div>
      </div>
    </section>

    </div><!-- tabLookup -->

    <div id="tabTPDR" class="hidden" role="tabpanel" aria-labelledby="tabBtnTPDR">
      <!-- TPDR CANDIDATES SECTION -->
      <section class="section" aria-labelledby="tpdr-candidates-heading">
        <div class="card">
          <div class="card__header">
            <div class="card__header-left">
              <span class="card__header-icon" aria-hidden="true">
                <svg viewBox="0 0 18 18" fill="none"><path d="M2 14l4-8 3 4 2-3 5 7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </span>
              <h2 class="card__title" id="tpdr-candidates-heading">TPDR Candidates</h2>
            </div>
            <button type="button" class="btn btn--secondary btn--small" id="tpdrRefreshBtn">Refresh</button>
          </div>
          <div class="card__body" id="tpdrCandidatesBody">
            <div class="state-message" id="tpdrLoading">
              <div class="state-message__icon"><div class="spinner spinner--large" role="status"><span class="sr-only">Loading TPDR analysis</span></div></div>
              <p class="state-message__text">Loading TPDR analysis data...</p>
            </div>
            <div class="hidden" id="tpdrError">
              <div class="state-message state-message--error" role="alert">
                <p class="state-message__text" id="tpdrErrorText">Failed to load TPDR data.</p>
              </div>
            </div>
            <div class="hidden" id="tpdrCandidatesResults"></div>
          </div>
        </div>
      </section>

      <!-- FLEET TREND OVERVIEW SECTION -->
      <section class="section" aria-labelledby="tpdr-trends-heading">
        <div class="card">
          <div class="card__header">
            <div class="card__header-left">
              <span class="card__header-icon" aria-hidden="true">
                <svg viewBox="0 0 18 18" fill="none"><path d="M2 16V2M2 14h14M5 11l3-4 3 3 4-6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </span>
              <h2 class="card__title" id="tpdr-trends-heading">Fleet Trend Overview</h2>
            </div>
          </div>
          <div class="card__body" id="tpdrTrendsBody">
            <div class="hidden" id="tpdrTrendsResults"></div>
          </div>
        </div>
      </section>
    </div><!-- tabTPDR -->

  </main>

  <!-- ================================================================
       FOOTER
       ================================================================ -->
  <footer class="app-footer" role="contentinfo">
    <div class="footer-powered">Powered by Local AI -- No Cloud Dependencies</div>
    <div class="footer-tech">
      <span class="tech-badge">Ollama</span>
      <span class="footer-separator" aria-hidden="true">|</span>
      <span class="tech-badge">nomic-embed-text</span>
      <span class="footer-separator" aria-hidden="true">|</span>
      <span class="tech-badge">qwen2.5:32b</span>
      <span class="footer-separator" aria-hidden="true">|</span>
      <span class="tech-badge">deepseek-r1:32b</span>
    </div>
    <div class="footer-classification">V-22 TAR Intelligence System v1.0 -- All processing performed on local infrastructure</div>
  </footer>

  <!-- ================================================================
       JAVASCRIPT
       ================================================================ -->
  <script>
    (function () {
      "use strict";

      /* ----------------------------------------------------------------
         STATE
         ---------------------------------------------------------------- */
      var searchResults = null;
      var searchText = "";
      var showAllCases = false;
      var INITIAL_CASES_SHOWN = 3;

      // localStorage helper with fallback
      var storage = (function() {
        var mem = {};
        var ls = null;
        try { ls = window.localStorage; ls.setItem('_test', '1'); ls.removeItem('_test'); } catch(e) { ls = null; }
        return {
          get: function(key) {
            if (ls) { try { var v = ls.getItem(key); return v ? JSON.parse(v) : null; } catch(e) { return mem[key] || null; } }
            return mem[key] || null;
          },
          set: function(key, val) {
            if (ls) { try { ls.setItem(key, JSON.stringify(val)); } catch(e) { mem[key] = val; } }
            else { mem[key] = val; }
          }
        };
      })();

      /* ----------------------------------------------------------------
         DOM REFERENCES
         ---------------------------------------------------------------- */
      var dom = {
        tarInput: document.getElementById("tarInput"),
        btnSearch: document.getElementById("btnSearch"),
        recommendRetry: document.getElementById("recommendRetry"),

        statTars: document.getElementById("statTars"),
        statMafs: document.getElementById("statMafs"),
        statClusters: document.getElementById("statClusters"),
        statParts: document.getElementById("statParts"),
        statusDot: document.getElementById("statusDot"),
        statusText: document.getElementById("statusText"),

        diagnosisEmpty: document.getElementById("diagnosisEmpty"),
        diagnosisLoading: document.getElementById("diagnosisLoading"),
        diagnosisError: document.getElementById("diagnosisError"),
        diagnosisErrorText: document.getElementById("diagnosisErrorText"),
        diagnosisResults: document.getElementById("diagnosisResults"),
        diagnosisTimer: document.getElementById("diagnosisTimer"),

        casesEmpty: document.getElementById("casesEmpty"),
        casesResults: document.getElementById("casesResults"),
        casesCount: document.getElementById("casesCount"),

        recommendEmpty: document.getElementById("recommendEmpty"),
        recommendLoading: document.getElementById("recommendLoading"),
        recommendLoadingText: document.getElementById("recommendLoadingText"),
        recommendError: document.getElementById("recommendError"),
        recommendErrorText: document.getElementById("recommendErrorText"),
        recommendResults: document.getElementById("recommendResults"),
        recommendTimer: document.getElementById("recommendTimer")
      };

      /* ----------------------------------------------------------------
         UTILITIES
         ---------------------------------------------------------------- */
      function formatNumber(n) {
        if (n === null || n === undefined) return "--";
        if (n >= 1000000) return (n / 1000000).toFixed(1) + "M";
        if (n >= 1000) return n.toLocaleString();
        return String(n);
      }

      /**
       * Safely escapes a string for use as text content within DOM
       * construction. Uses the browser's built-in text node escaping
       * to prevent XSS.
       */
      function escapeHtml(str) {
        if (!str) return "";
        var div = document.createElement("div");
        div.appendChild(document.createTextNode(str));
        return div.textContent !== undefined ? div.innerHTML : div.innerText;
      }

      function show(el) { el.classList.remove("hidden"); }
      function hide(el) { el.classList.add("hidden"); }

      function confidenceColor(conf) {
        if (conf >= 0.8) return "var(--accent-green)";
        if (conf >= 0.6) return "var(--accent-blue)";
        if (conf >= 0.4) return "var(--accent-amber)";
        return "var(--accent-red)";
      }

      function similarityBadgeClass(sim) {
        if (sim >= 0.85) return "similarity-badge--high";
        if (sim >= 0.70) return "similarity-badge--medium";
        return "similarity-badge--low";
      }

      var barColors = [
        "var(--bar-replace)",
        "var(--bar-inspect)",
        "var(--bar-adjust)",
        "var(--bar-repair)",
        "var(--bar-other)"
      ];

      function getBarColor(index) {
        return barColors[index % barColors.length];
      }

      /**
       * Builds a DOM element tree from a descriptor object.
       * Avoids direct innerHTML usage for dynamic content.
       *
       * @param {string} tag - HTML tag name
       * @param {Object} attrs - attributes and properties
       * @param {Array} children - child elements or strings
       * @returns {HTMLElement}
       */
      function h(tag, attrs, children) {
        var el = document.createElement(tag);
        if (attrs) {
          Object.keys(attrs).forEach(function (key) {
            if (key === "className") {
              el.className = attrs[key];
            } else if (key === "style" && typeof attrs[key] === "object") {
              Object.keys(attrs[key]).forEach(function (sk) {
                el.style[sk] = attrs[key][sk];
              });
            } else if (key.indexOf("aria") === 0 || key === "role" || key === "tabindex") {
              el.setAttribute(key.replace(/([A-Z])/g, "-$1").toLowerCase(), attrs[key]);
            } else {
              el.setAttribute(key, attrs[key]);
            }
          });
        }
        if (children) {
          if (!Array.isArray(children)) children = [children];
          children.forEach(function (child) {
            if (child === null || child === undefined) return;
            if (typeof child === "string" || typeof child === "number") {
              el.appendChild(document.createTextNode(String(child)));
            } else if (child instanceof Node) {
              el.appendChild(child);
            }
          });
        }
        return el;
      }

      /* ----------------------------------------------------------------
         API CALLS
         ---------------------------------------------------------------- */
      async function apiGet(endpoint) {
        var response = await fetch(endpoint);
        if (!response.ok) {
          var body = await response.text();
          throw new Error("HTTP " + response.status + ": " + body);
        }
        return response.json();
      }

      async function apiPost(endpoint, data) {
        var response = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        if (!response.ok) {
          var body = await response.text();
          throw new Error("HTTP " + response.status + ": " + body);
        }
        return response.json();
      }

      /* ----------------------------------------------------------------
         LOAD STATS
         ---------------------------------------------------------------- */
      async function loadStats() {
        try {
          var stats = await apiGet("/api/stats");
          dom.statTars.textContent = formatNumber(stats.total_tars);
          dom.statMafs.textContent = formatNumber(stats.total_mafs);
          dom.statClusters.textContent = String(stats.cluster_count);
          dom.statParts.textContent = String(stats.parts_tracked);

          if (stats.index_loaded) {
            dom.statusDot.classList.remove("status-indicator__dot--offline");
            dom.statusText.textContent = "System Ready";
          } else {
            dom.statusDot.classList.add("status-indicator__dot--offline");
            dom.statusText.textContent = "Index Loading...";
          }
        } catch (e) {
          dom.statusDot.classList.add("status-indicator__dot--offline");
          dom.statusText.textContent = "Connection Failed";
        }
      }

      /* ----------------------------------------------------------------
         SEARCH
         ---------------------------------------------------------------- */
      var searchBtnOrigNodes = null;

      async function performSearch() {
        var text = dom.tarInput.value.trim();
        if (!text) {
          dom.tarInput.focus();
          return;
        }

        searchText = text;
        searchResults = null;
        showAllCases = false;

        // Show loading state
        hide(dom.diagnosisEmpty);
        hide(dom.diagnosisError);
        hide(dom.diagnosisResults);
        show(dom.diagnosisLoading);
        hide(dom.diagnosisTimer);

        hide(dom.casesEmpty);
        hide(dom.casesResults);
        hide(dom.casesCount);

        // Reset recommendation  show loading immediately (will auto-fire after search)
        hide(dom.recommendEmpty);
        hide(dom.recommendError);
        hide(dom.recommendResults);
        hide(dom.recommendTimer);
        show(dom.recommendLoading);

        // Disable search button during request
        dom.btnSearch.disabled = true;
        if (!searchBtnOrigNodes) {
          searchBtnOrigNodes = [];
          while (dom.btnSearch.firstChild) {
            searchBtnOrigNodes.push(dom.btnSearch.removeChild(dom.btnSearch.firstChild));
          }
        } else {
          while (dom.btnSearch.firstChild) dom.btnSearch.removeChild(dom.btnSearch.firstChild);
        }
        var spinEl = document.createElement("span");
        spinEl.className = "spinner";
        spinEl.setAttribute("aria-hidden", "true");
        dom.btnSearch.appendChild(spinEl);
        dom.btnSearch.appendChild(document.createTextNode(" Searching..."));

        var startTime = performance.now();

        try {
          var results = await apiPost("/api/search", { text: text, top_k: 10 });
          var elapsed = ((performance.now() - startTime) / 1000).toFixed(2);

          searchResults = results;

          // Render diagnosis
          renderDiagnosis(results);
          show(dom.diagnosisTimer);
          dom.diagnosisTimer.textContent = elapsed + "s";

          // Render similar cases
          renderSimilarCases(results.similar_tars);
          show(dom.casesCount);
          dom.casesCount.textContent = results.similar_tars.length + " cases";

          // Auto-trigger AI recommendation (non-blocking)
          fireAutoRecommendation(text, results);

        } catch (e) {
          hide(dom.diagnosisLoading);
          dom.diagnosisErrorText.textContent = "Search failed: " + e.message;
          show(dom.diagnosisError);
          show(dom.casesEmpty);
          // No search results  hide recommendation loading, show empty
          hide(dom.recommendLoading);
          show(dom.recommendEmpty);
        } finally {
          dom.btnSearch.disabled = false;
          // Restore original button content
          while (dom.btnSearch.firstChild) dom.btnSearch.removeChild(dom.btnSearch.firstChild);
          if (searchBtnOrigNodes) {
            searchBtnOrigNodes.forEach(function (node) {
              dom.btnSearch.appendChild(node);
            });
          }
          searchBtnOrigNodes = null;
        }
      }

      /* ----------------------------------------------------------------
         RENDER: DIAGNOSIS (DOM-based, no innerHTML for dynamic data)
         ---------------------------------------------------------------- */
      function renderDiagnosis(results) {
        hide(dom.diagnosisLoading);
        hide(dom.diagnosisError);
        hide(dom.diagnosisEmpty);

        var cluster = results.matched_cluster;
        if (!cluster) {
          dom.diagnosisErrorText.textContent = "No matching cluster found in the database.";
          show(dom.diagnosisError);
          return;
        }

        // Clear previous
        while (dom.diagnosisResults.firstChild) {
          dom.diagnosisResults.removeChild(dom.diagnosisResults.firstChild);
        }

        var confPct = Math.round(cluster.confidence * 100);
        var confColor = confidenceColor(cluster.confidence);

        // Build solution breakdown
        var breakdownEntries = Object.entries(cluster.solution_breakdown || {});
        breakdownEntries.sort(function (a, b) { return b[1] - a[1]; });
        var maxPct = breakdownEntries.length > 0 ? breakdownEntries[0][1] : 100;

        var breakdownContainer = h("div", null, [
          h("div", { className: "solution-breakdown__title" }, ["Solution Breakdown"])
        ]);

        breakdownEntries.forEach(function (entry, i) {
          var label = entry[0];
          var pct = entry[1];
          var width = Math.max((pct / maxPct) * 100, 2);
          var color = getBarColor(i);

          var barFill = h("div", {
            className: "solution-item__bar-fill",
            style: { width: width + "%", background: color }
          });

          var barTrack = h("div", {
            className: "solution-item__bar-track",
            role: "progressbar",
            "aria-valuenow": pct.toFixed(1),
            "aria-valuemin": "0",
            "aria-valuemax": "100",
            "aria-label": label + ": " + pct.toFixed(1) + "%"
          }, [barFill]);

          breakdownContainer.appendChild(
            h("div", { className: "solution-item" }, [
              h("span", { className: "solution-item__label" }, [label]),
              barTrack,
              h("span", { className: "solution-item__pct" }, [pct.toFixed(1) + "%"])
            ])
          );
        });

        // Parts list
        var relatedParts = results.related_parts || [];
        var clusterParts = cluster.parts_commonly_involved || [];
        var partsToShow = [];

        if (relatedParts.length > 0) {
          relatedParts.forEach(function (rp) {
            partsToShow.push({
              part_number: rp.part_number,
              failure_count: rp.failure_count,
              ai_summary: rp.ai_summary || ""
            });
          });
        } else if (clusterParts.length > 0) {
          clusterParts.forEach(function (pn) {
            partsToShow.push({ part_number: pn, failure_count: 0, ai_summary: "" });
          });
        }

        var partsContainer = null;
        if (partsToShow.length > 0) {
          var ul = h("ul");
          partsToShow.forEach(function (p) {
            var liChildren = [
              h("span", { className: "part-number" }, [p.part_number])
            ];
            if (p.failure_count > 0) {
              liChildren.push(
                h("span", { className: "part-failures" }, ["(" + formatNumber(p.failure_count) + " historical failures)"])
              );
            }
            if (p.ai_summary) {
              var summary = p.ai_summary.length > 120 ? p.ai_summary.substring(0, 120) + "..." : p.ai_summary;
              liChildren.push(h("span", { className: "part-summary" }, [summary]));
            }
            ul.appendChild(h("li", null, liChildren));
          });
          partsContainer = h("div", { className: "parts-list" }, [
            h("div", { className: "parts-list__title" }, ["Parts to Have Ready"]),
            ul
          ]);
        }

        // Confidence bar
        var confFill = h("div", {
          className: "confidence-bar__fill",
          style: { width: confPct + "%", background: confColor }
        });

        var confBarTrack = h("div", {
          className: "confidence-bar__track",
          role: "progressbar",
          "aria-valuenow": String(confPct),
          "aria-valuemin": "0",
          "aria-valuemax": "100",
          "aria-label": "Confidence: " + confPct + "%"
        }, [confFill]);

        var confBar = h("div", { className: "confidence-bar" }, [
          h("div", { className: "confidence-bar__header" }, [
            h("span", { className: "confidence-bar__label" }, ["Match Confidence"]),
            h("span", { className: "confidence-bar__value", style: { color: confColor } }, [confPct + "%"])
          ]),
          confBarTrack
        ]);

        // Stat units styling helper
        function statUnit(text) {
          var sp = document.createElement("span");
          sp.style.fontSize = "0.6em";
          sp.style.color = "var(--text-muted)";
          sp.textContent = text;
          return sp;
        }

        function pctUnit() {
          var sp = document.createElement("span");
          sp.style.fontSize = "0.75em";
          sp.style.color = "var(--text-muted)";
          sp.textContent = "%";
          return sp;
        }

        // Stats row
        var confStatVal = h("span", { className: "diagnosis-stat__value" }, []);
        confStatVal.appendChild(document.createTextNode(String(confPct)));
        confStatVal.appendChild(pctUnit());

        var occStatVal = h("span", { className: "diagnosis-stat__value" }, [formatNumber(cluster.occurrences)]);

        var mhText = cluster.average_manhours > 0 ? cluster.average_manhours.toFixed(1) : "--";
        var mhStatVal = h("span", { className: "diagnosis-stat__value" }, []);
        mhStatVal.appendChild(document.createTextNode(mhText));
        if (cluster.average_manhours > 0) {
          mhStatVal.appendChild(statUnit(" hrs"));
        }

        var statsRow = h("div", { className: "diagnosis-stats" }, [
          h("div", { className: "diagnosis-stat" }, [
            confStatVal,
            h("span", { className: "diagnosis-stat__label" }, ["Confidence"])
          ]),
          h("div", { className: "diagnosis-stat" }, [
            occStatVal,
            h("span", { className: "diagnosis-stat__label" }, ["Past Occurrences"])
          ]),
          h("div", { className: "diagnosis-stat" }, [
            mhStatVal,
            h("span", { className: "diagnosis-stat__label" }, ["Avg Resolution"])
          ])
        ]);

        // Left column
        var leftChildren = [
          h("div", { className: "diagnosis-category" }, [cluster.problem]),
          statsRow,
          confBar
        ];
        if (partsContainer) leftChildren.push(partsContainer);
        var leftCol = h("div", { className: "diagnosis-left" }, leftChildren);

        // Right column
        var rightCol = h("div", { className: "diagnosis-right" }, [breakdownContainer]);

        // Grid
        var grid = h("div", { className: "diagnosis-grid" }, [leftCol, rightCol]);
        dom.diagnosisResults.appendChild(grid);

        // Insight
        if (cluster.typical_solution) {
          var insight = h("div", { className: "insight-text" }, [
            h("div", { className: "insight-text__title" }, ["Historical Insight"]),
            h("p", { className: "insight-text__body" }, [cluster.typical_solution])
          ]);
          dom.diagnosisResults.appendChild(insight);
        }

        show(dom.diagnosisResults);

        // Animate bars
        requestAnimationFrame(function () {
          var fills = dom.diagnosisResults.querySelectorAll(".solution-item__bar-fill, .confidence-bar__fill");
          fills.forEach(function (f) {
            var targetWidth = f.style.width;
            f.style.width = "0%";
            requestAnimationFrame(function () {
              f.style.width = targetWidth;
            });
          });
        });
      }

      /* ----------------------------------------------------------------
         RENDER: SIMILAR CASES (DOM-based)
         ---------------------------------------------------------------- */
      function getFlagCount() {
        var flags = storage.get("tars_tarFlags") || {};
        return Object.keys(flags).length;
      }

      function updateFlagCounter() {
        var counterEl = document.getElementById("flagCounter");
        if (!counterEl) return;
        var count = getFlagCount();
        if (count > 0) {
          counterEl.textContent = count + " correction" + (count !== 1 ? "s" : "") + " submitted";
          show(counterEl);
        } else {
          hide(counterEl);
        }
      }

      function renderSimilarCases(cases) {
        hide(dom.casesEmpty);

        if (!cases || cases.length === 0) {
          show(dom.casesEmpty);
          return;
        }

        // Clear previous
        while (dom.casesResults.firstChild) {
          dom.casesResults.removeChild(dom.casesResults.firstChild);
        }

        // Flag counter (create once, reuse on re-renders)
        if (!document.getElementById("flagCounter")) {
          var flagCounter = h("span", { id: "flagCounter", className: "flag-counter hidden" });
          dom.casesCount.parentNode.appendChild(flagCounter);
        }
        updateFlagCounter();

        var flags = storage.get("tars_tarFlags") || {};
        var visibleCount = showAllCases ? cases.length : Math.min(INITIAL_CASES_SHOWN, cases.length);

        var list = h("div", { className: "cases-list", role: "list" });

        for (var i = 0; i < visibleCount; i++) {
          var tar = cases[i];
          var simPct = Math.round(tar.similarity * 100);
          var badgeClass = similarityBadgeClass(tar.similarity);
          var jcn = tar.jcn || "N/A";
          var isFlagged = !!(flags[jcn] && flags[jcn].flagged);

          // Header left
          var headerLeftChildren = [
            h("span", { className: "similarity-badge " + badgeClass, "aria-label": simPct + "% match" }, [simPct + "% match"]),
            h("span", { className: "case-jcn" }, ["JCN: " + jcn])
          ];
          var headerLeft = h("div", { className: "case-card__header-left" }, headerLeftChildren);

          // Header right: cluster label + flag button
          var headerRightChildren = [];
          if (tar.cluster_label) {
            headerRightChildren.push(h("span", { className: "case-cluster-label" }, [tar.cluster_label]));
          }

          var flagBtn = h("button", {
            type: "button",
            className: "flag-btn" + (isFlagged ? " flag-btn--flagged" : ""),
            "aria-label": isFlagged ? "Flagged as not related" : "Flag as not related"
          }, [isFlagged ? "Flagged \u2713" : "Not Related"]);

          headerRightChildren.push(flagBtn);

          var headerRight = h("div", { style: { display: "flex", alignItems: "center", gap: "8px" } }, headerRightChildren);

          var headerChildren = [headerLeft, headerRight];
          var cardHeader = h("div", { className: "case-card__header" }, headerChildren);

          // Body
          var bodyChildren = [];
          if (tar.subject) {
            bodyChildren.push(h("div", { className: "case-subject" }, [tar.subject]));
          }
          if (tar.issue) {
            bodyChildren.push(h("div", { className: "case-issue" }, [tar.issue]));
          }

          // MAF actions
          if (tar.maf_actions && tar.maf_actions.length > 0) {
            var mafContainer = h("div", { className: "maf-actions" }, [
              h("div", { className: "maf-actions__title" }, ["Corrective Actions Taken"])
            ]);

            tar.maf_actions.forEach(function (maf) {
              var corr = maf.corr_act || maf.discrepancy || "";
              var displayCorr = corr.length > 200 ? corr.substring(0, 200) + "..." : corr;
              var hours = maf.manhours || "";
              var parts = [];
              if (maf.rmvd_partno) parts.push(maf.rmvd_partno);
              if (maf.inst_partno && maf.inst_partno !== maf.rmvd_partno) parts.push(maf.inst_partno);
              var partsStr = parts.join(", ");

              var actionChildren = [
                h("span", { className: "maf-action__text" }, [displayCorr])
              ];
              actionChildren.push(
                hours ? h("span", { className: "maf-action__hours" }, [hours + " hrs"]) : h("span")
              );
              actionChildren.push(
                partsStr ? h("span", { className: "maf-action__parts" }, [partsStr]) : h("span")
              );

              mafContainer.appendChild(h("div", { className: "maf-action" }, actionChildren));
            });

            bodyChildren.push(mafContainer);
          }

          var cardBody = h("div", { className: "case-card__body" }, bodyChildren);

          var caseCard = h("div", { className: "case-card" + (isFlagged ? " case-card--flagged" : ""), role: "listitem" }, [cardHeader, cardBody]);

          // Flag button click handler
          (function(btn, card, caseJcn) {
            btn.addEventListener("click", function() {
              var allFlags = storage.get("tars_tarFlags") || {};
              allFlags[caseJcn] = { flagged: true, timestamp: new Date().toISOString() };
              storage.set("tars_tarFlags", allFlags);
              btn.textContent = "Flagged \u2713";
              btn.classList.add("flag-btn--flagged");
              btn.setAttribute("aria-label", "Flagged as not related");
              card.classList.add("case-card--flagged");
              updateFlagCounter();
            });
          })(flagBtn, caseCard, jcn);

          list.appendChild(caseCard);
        }

        dom.casesResults.appendChild(list);

        // Show More / Show Less button
        if (cases.length > INITIAL_CASES_SHOWN) {
          var toggleBtn;
          if (!showAllCases) {
            toggleBtn = h("button", {
              type: "button",
              className: "show-more-btn",
              "aria-label": "Show all " + cases.length + " similar cases"
            }, ["Show " + (cases.length - INITIAL_CASES_SHOWN) + " more cases"]);
            toggleBtn.addEventListener("click", function () {
              showAllCases = true;
              renderSimilarCases(searchResults.similar_tars);
            });
          } else {
            toggleBtn = h("button", {
              type: "button",
              className: "show-more-btn",
              "aria-label": "Show fewer cases"
            }, ["Show fewer"]);
            toggleBtn.addEventListener("click", function () {
              showAllCases = false;
              renderSimilarCases(searchResults.similar_tars);
              document.getElementById("casesSection").scrollIntoView({ behavior: "smooth", block: "start" });
            });
          }
          dom.casesResults.appendChild(toggleBtn);
        }

        show(dom.casesResults);
      }

      /* ----------------------------------------------------------------
         AI RECOMMENDATION (auto-triggered after search)
         ---------------------------------------------------------------- */
      var recommendGeneration = 0;

      function countMafActions(results) {
        var count = 0;
        var tars = results.similar_tars || [];
        for (var i = 0; i < tars.length; i++) {
          var actions = tars[i].maf_actions || [];
          count += actions.length;
        }
        return count;
      }

      function fireAutoRecommendation(text, results) {
        var gen = ++recommendGeneration;
        var nTars = (results.similar_tars || []).length;
        var mActions = countMafActions(results);

        hide(dom.recommendEmpty);
        hide(dom.recommendError);
        hide(dom.recommendResults);
        hide(dom.recommendTimer);
        show(dom.recommendLoading);

        // Dynamic loading message with context counts
        dom.recommendLoadingText.textContent =
          "Analyzing with qwen2.5:32b running locally \u2014 cross-referencing " +
          nTars + " similar case" + (nTars !== 1 ? "s" : "") + " and " +
          mActions + " corrective action" + (mActions !== 1 ? "s" : "") + "...";

        var startTime = performance.now();
        var body = JSON.stringify({ text: text, search_results: results });

        fetch("/api/recommend", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: body
        })
        .then(function(response) {
          if (gen !== recommendGeneration) return null;
          if (!response.ok) return response.text().then(function(t) { throw new Error("HTTP " + response.status + ": " + t); });
          return response.json();
        })
        .then(function(data) {
          if (!data || gen !== recommendGeneration) return;

          var elapsed = ((performance.now() - startTime) / 1000).toFixed(1);
          hide(dom.recommendLoading);

          var recText = data.recommendation || "No recommendation generated.";

          while (dom.recommendResults.firstChild) {
            dom.recommendResults.removeChild(dom.recommendResults.firstChild);
          }

          var recContainer = h("div", { className: "recommendation-text" });

          var paragraphs = recText.split(/\n\n+/);
          paragraphs.forEach(function (para) {
            if (para.trim()) {
              var pEl = document.createElement("p");
              var lines = para.split(/\n/);
              lines.forEach(function (line, lineIdx) {
                if (lineIdx > 0) {
                  pEl.appendChild(document.createElement("br"));
                }
                pEl.appendChild(document.createTextNode(line));
              });
              pEl.style.marginBottom = "12px";
              recContainer.appendChild(pEl);
            }
          });

          // Metadata footer
          var footer = h("div", {
            style: { fontSize: "0.75rem", color: "var(--text-muted)", marginTop: "16px", paddingTop: "12px", borderTop: "1px solid var(--border-color)" }
          }, [
            "Generated by qwen2.5:32b \u00b7 " + nTars + " similar TAR" + (nTars !== 1 ? "s" : "") +
            " \u00b7 " + mActions + " MAF action" + (mActions !== 1 ? "s" : "") +
            " in context \u00b7 " + elapsed + "s"
          ]);
          recContainer.appendChild(footer);

          dom.recommendResults.appendChild(recContainer);
          show(dom.recommendResults);
          hide(dom.recommendTimer);
        })
        .catch(function(e) {
          if (gen !== recommendGeneration) return;
          hide(dom.recommendLoading);
          dom.recommendErrorText.textContent = "Recommendation failed: " + e.message;
          show(dom.recommendError);
        });
      }

      /* ----------------------------------------------------------------
         TAR QUEUE STATE & LOGIC
         ---------------------------------------------------------------- */
      var tarQueueLoaded = false;
      var tarQueueData = [];
      var tarQueueFilters = null;
      var tarQueueSelectedJcn = null;
      var tarQueueCurrentLimit = 50;
      var tarQueueDebounceTimer = null;
      var tarQueueTotalCount = 0;

      var tqDom = {
        loading: document.getElementById("tarQueueLoading"),
        content: document.getElementById("tarQueueContent"),
        count: document.getElementById("tarQueueCount"),
        search: document.getElementById("tarQueueSearch"),
        workCenter: document.getElementById("tarQueueWorkCenter"),
        activity: document.getElementById("tarQueueActivity"),
        priority: document.getElementById("tarQueuePriority"),
        clearBtn: document.getElementById("tarQueueClearBtn"),
        tbody: document.getElementById("tarQueueTableBody"),
        showing: document.getElementById("tarQueueShowing"),
        loadMore: document.getElementById("tarQueueLoadMore")
      };

      function tqFormatDate(dateStr) {
        if (!dateStr) return "";
        var d = new Date(dateStr);
        if (isNaN(d.getTime())) return dateStr.substring(0, 10);
        var mm = String(d.getMonth() + 1).padStart(2, "0");
        var dd = String(d.getDate()).padStart(2, "0");
        return mm + "/" + dd + "/" + d.getFullYear();
      }

      function tqSystemName(uns) {
        if (!uns) return "";
        var parts = uns.match(/^\d+\s+(.+)/);
        return parts ? parts[1] : uns;
      }

      function tqPriorityInfo(p) {
        if (!p) return { cls: "", label: p || "" };
        var pl = p.toLowerCase();
        if (pl === "urgent" || pl.indexOf("1") === 0 || pl === "1")
          return { cls: "tq-priority--urgent", label: p };
        if (pl === "priority" || pl.indexOf("2") === 0 || pl === "2")
          return { cls: "tq-priority--priority", label: p };
        return { cls: "", label: p };
      }

      function tqBuildParams() {
        var params = new URLSearchParams();
        params.set("limit", String(tarQueueCurrentLimit));
        var sv = tqDom.search.value.trim();
        if (sv) params.set("search", sv);
        var wc = tqDom.workCenter.value;
        if (wc) params.set("work_center", wc);
        var act = tqDom.activity.value;
        if (act) params.set("activity", act);
        var pri = tqDom.priority.value;
        if (pri) params.set("priority", pri);
        return params.toString();
      }

      async function tqFetchTars() {
        var qs = tqBuildParams();
        var data = await apiGet("/api/tars/recent?" + qs);
        return data;
      }

      function tqRenderRows(data) {
        tarQueueData = data;
        while (tqDom.tbody.firstChild) tqDom.tbody.removeChild(tqDom.tbody.firstChild);

        if (data.length === 0) {
          var emptyRow = h("tr", {}, [
            h("td", { colspan: "5", style: { textAlign: "center", padding: "24px", color: "var(--text-muted)" } }, ["No TARs match the current filters."])
          ]);
          tqDom.tbody.appendChild(emptyRow);
          hide(tqDom.loadMore);
          tqDom.showing.textContent = "0 TARs";
          return;
        }

        data.forEach(function(tar) {
          var pri = tqPriorityInfo(tar.priority);
          var sysName = tqSystemName(tar.uns);
          var subjectDisplay = tar.subject || "";
          if (subjectDisplay.length > 80) subjectDisplay = subjectDisplay.substring(0, 80) + "\u2026";

          var priCell = [];
          if (pri.cls) {
            priCell.push(h("span", { className: "tq-priority-indicator " + pri.cls }, []));
          }
          priCell.push(document.createTextNode(pri.label));

          var row = h("tr", { className: "tar-queue__row" + (tar.jcn === tarQueueSelectedJcn ? " tar-queue__row--selected" : "") }, [
            h("td", { className: "tq-jcn" }, [tar.jcn]),
            h("td", { className: "tq-date" }, [tqFormatDate(tar.submit_date)]),
            h("td", {}, priCell),
            h("td", { className: "tq-system", title: tar.uns }, [sysName]),
            h("td", { className: "tq-subject", title: tar.subject }, [subjectDisplay])
          ]);

          (function(r, t) {
            r.addEventListener("click", function() {
              tqSelectRow(r, t);
            });
          })(row, tar);

          tqDom.tbody.appendChild(row);
        });

        tqDom.showing.textContent = "Showing " + data.length + " TARs";
        show(tqDom.count);
        tqDom.count.textContent = data.length + " TARs";

        if (data.length >= tarQueueCurrentLimit && tarQueueCurrentLimit < 200) {
          show(tqDom.loadMore);
        } else {
          hide(tqDom.loadMore);
        }
      }

      function tqSelectRow(rowEl, tar) {
        // Deselect previous
        var prev = tqDom.tbody.querySelector(".tar-queue__row--selected");
        if (prev) prev.classList.remove("tar-queue__row--selected");

        // Select this row
        rowEl.classList.add("tar-queue__row--selected");
        tarQueueSelectedJcn = tar.jcn;

        // Populate textarea with full text
        var fullText = (tar.subject || "").trim();
        if (tar.issue) fullText += "\n" + tar.issue.trim();
        dom.tarInput.value = fullText;

        // Auto-trigger search
        performSearch();

        // Smooth scroll to diagnosis
        var diagSection = document.getElementById("diagnosisSection");
        if (diagSection) {
          setTimeout(function() {
            diagSection.scrollIntoView({ behavior: "smooth", block: "start" });
          }, 100);
        }
      }

      async function tqRefresh() {
        try {
          var data = await tqFetchTars();
          tqRenderRows(data);
        } catch (e) {
          tqDom.showing.textContent = "Error loading TARs";
        }
      }

      function tqDebouncedRefresh() {
        if (tarQueueDebounceTimer) clearTimeout(tarQueueDebounceTimer);
        tarQueueDebounceTimer = setTimeout(function() {
          tarQueueCurrentLimit = 50;
          tqRefresh();
        }, 300);
      }

      async function loadTarQueue() {
        show(tqDom.loading);
        hide(tqDom.content);

        try {
          // Fetch filters and initial data in parallel
          var filtersPromise = apiGet("/api/tars/filters");
          var dataPromise = tqFetchTars();
          var results = await Promise.all([filtersPromise, dataPromise]);

          tarQueueFilters = results[0];
          var data = results[1];

          // Populate filter dropdowns
          function populateSelect(selectEl, values, allLabel) {
            while (selectEl.options.length > 1) selectEl.remove(1);
            values.forEach(function(v) {
              var opt = document.createElement("option");
              opt.value = v;
              opt.textContent = v;
              selectEl.appendChild(opt);
            });
          }

          populateSelect(tqDom.workCenter, tarQueueFilters.work_centers || []);
          populateSelect(tqDom.activity, tarQueueFilters.activities || []);
          populateSelect(tqDom.priority, tarQueueFilters.priorities || []);

          // Render rows
          tqRenderRows(data);

          hide(tqDom.loading);
          show(tqDom.content);
          tarQueueLoaded = true;

        } catch (e) {
          hide(tqDom.loading);
          tqDom.loading.parentNode.insertBefore(
            h("div", { style: { padding: "16px", color: "var(--accent-red)", fontSize: "0.8125rem" } },
              ["Failed to load TAR queue: " + e.message]),
            tqDom.loading.nextSibling
          );
        }
      }

      // Wire up TAR Queue events
      tqDom.search.addEventListener("input", tqDebouncedRefresh);
      tqDom.workCenter.addEventListener("change", function() { tarQueueCurrentLimit = 50; tqRefresh(); });
      tqDom.activity.addEventListener("change", function() { tarQueueCurrentLimit = 50; tqRefresh(); });
      tqDom.priority.addEventListener("change", function() { tarQueueCurrentLimit = 50; tqRefresh(); });
      tqDom.clearBtn.addEventListener("click", function() {
        tqDom.search.value = "";
        tqDom.workCenter.value = "";
        tqDom.activity.value = "";
        tqDom.priority.value = "";
        tarQueueCurrentLimit = 50;
        tarQueueSelectedJcn = null;
        tqRefresh();
      });
      tqDom.loadMore.addEventListener("click", function() {
        tarQueueCurrentLimit = 200;
        tqRefresh();
      });

      /* ----------------------------------------------------------------
         TPDR STATE
         ---------------------------------------------------------------- */
      var tpdrData = null;
      var tpdrLoaded = false;
      var tpdrExpandedCards = {};

      var fleetData = null;
      var fleetLoaded = false;

      var tpdrDom = {
        tabBtnFleet: document.getElementById("tabBtnFleet"),
        tabBtnLookup: document.getElementById("tabBtnLookup"),
        tabBtnTPDR: document.getElementById("tabBtnTPDR"),
        tabFleetAnalytics: document.getElementById("tabFleetAnalytics"),
        tabLookup: document.getElementById("tabLookup"),
        tabTPDR: document.getElementById("tabTPDR"),
        fleetLoading: document.getElementById("fleetLoading"),
        fleetError: document.getElementById("fleetError"),
        fleetErrorText: document.getElementById("fleetErrorText"),
        fleetResults: document.getElementById("fleetResults"),
        tpdrLoading: document.getElementById("tpdrLoading"),
        tpdrError: document.getElementById("tpdrError"),
        tpdrErrorText: document.getElementById("tpdrErrorText"),
        tpdrCandidatesResults: document.getElementById("tpdrCandidatesResults"),
        tpdrCandidatesBody: document.getElementById("tpdrCandidatesBody"),
        tpdrTrendsResults: document.getElementById("tpdrTrendsResults"),
        tpdrRefreshBtn: document.getElementById("tpdrRefreshBtn"),
      };

      /* ----------------------------------------------------------------
         TAB SWITCHING
         ---------------------------------------------------------------- */
      function switchTab(tabName) {
        var tabs = {
          fleet:  { btn: tpdrDom.tabBtnFleet,  panel: tpdrDom.tabFleetAnalytics },
          lookup: { btn: tpdrDom.tabBtnLookup, panel: tpdrDom.tabLookup },
          tpdr:   { btn: tpdrDom.tabBtnTPDR,   panel: tpdrDom.tabTPDR }
        };
        Object.keys(tabs).forEach(function(key) {
          if (key === tabName) {
            tabs[key].btn.classList.add("tab-btn--active");
            tabs[key].btn.setAttribute("aria-selected", "true");
            show(tabs[key].panel);
          } else {
            tabs[key].btn.classList.remove("tab-btn--active");
            tabs[key].btn.setAttribute("aria-selected", "false");
            hide(tabs[key].panel);
          }
        });
        if (tabName === "tpdr" && !tpdrLoaded) loadTPDRData();
        if (tabName === "lookup" && !tarQueueLoaded) loadTarQueue();
        if (tabName === "fleet" && !fleetLoaded) loadFleetData();
      }

      /* ----------------------------------------------------------------
         TPDR HELPERS
         ---------------------------------------------------------------- */
      function createSparkline(data, width, height, color) {
        if (!data || data.length === 0) return document.createTextNode("");
        var max = Math.max.apply(null, data);
        if (max === 0) max = 1;
        var ns = "http://www.w3.org/2000/svg";
        var svg = document.createElementNS(ns, "svg");
        svg.setAttribute("width", String(width));
        svg.setAttribute("height", String(height));
        svg.setAttribute("viewBox", "0 0 " + width + " " + height);
        svg.style.display = "block";

        var points = data.map(function(val, i) {
          var x = (i / Math.max(data.length - 1, 1)) * (width - 2) + 1;
          var y = height - 2 - ((val / max) * (height - 4));
          return x + "," + y;
        }).join(" ");

        var polyline = document.createElementNS(ns, "polyline");
        polyline.setAttribute("points", points);
        polyline.setAttribute("fill", "none");
        polyline.setAttribute("stroke", color || "var(--accent-blue)");
        polyline.setAttribute("stroke-width", "1.5");
        polyline.setAttribute("stroke-linecap", "round");
        polyline.setAttribute("stroke-linejoin", "round");
        svg.appendChild(polyline);

        var areaPoints = "1," + height + " " + points + " " + (width - 1) + "," + height;
        var polygon = document.createElementNS(ns, "polygon");
        polygon.setAttribute("points", areaPoints);
        polygon.setAttribute("fill", color || "var(--accent-blue)");
        polygon.setAttribute("opacity", "0.1");
        svg.appendChild(polygon);

        return svg;
      }

      function accelColor(ratio) {
        if (ratio > 3.0) return { dot: "tpdr-trend-dot--critical", ratio: "tpdr-trend-ratio--critical", color: "var(--accent-red)" };
        if (ratio >= 2.0) return { dot: "tpdr-trend-dot--moderate", ratio: "tpdr-trend-ratio--moderate", color: "var(--accent-amber)" };
        if (ratio < 1.0) return { dot: "tpdr-trend-dot--declining", ratio: "tpdr-trend-ratio--declining", color: "var(--accent-green)" };
        return { dot: "tpdr-trend-dot--stable", ratio: "tpdr-trend-ratio--stable", color: "var(--text-muted)" };
      }

      /* ----------------------------------------------------------------
         LOAD TPDR DATA
         ---------------------------------------------------------------- */
      async function loadTPDRData() {
        show(tpdrDom.tpdrLoading);
        hide(tpdrDom.tpdrError);
        hide(tpdrDom.tpdrCandidatesResults);
        hide(tpdrDom.tpdrTrendsResults);

        try {
          var recData = await apiGet("/api/tpdr/recommendations");
          var trendData = await apiGet("/api/tpdr/trends");
          var cbData = await apiGet("/api/tpdr/comebacks");

          tpdrData = {
            recommendations: recData.recommendations || [],
            trends: trendData.trends || [],
            comebacks: cbData.comebacks || [],
            computed_at: recData.computed_at || ""
          };
          tpdrLoaded = true;

          hide(tpdrDom.tpdrLoading);
          renderTPDRCandidates(tpdrData.recommendations);
          renderTPDRTrends(tpdrData.trends);
        } catch (e) {
          hide(tpdrDom.tpdrLoading);
          tpdrDom.tpdrErrorText.textContent = "Failed to load TPDR data: " + e.message;
          show(tpdrDom.tpdrError);
        }
      }

      /* ----------------------------------------------------------------
         TPDR WORKFLOW HELPERS
         ---------------------------------------------------------------- */
      var TPDR_THRESHOLD_DEFAULTS = {
        minTotalTars: 10,
        minAircraft: 3,
        minAcceleration: 1.5,
        minComebacks: 1,
        minMonthlyRate: 2,
        recentWindow: 6
      };

      function getWorkflowStates() {
        return storage.get("tars_tpdrWorkflow") || {};
      }

      function setWorkflowState(uns, state, note) {
        var states = getWorkflowStates();
        if (state === "active") {
          delete states[uns];
        } else {
          states[uns] = {
            state: state,
            timestamp: new Date().toISOString(),
            note: note || ""
          };
        }
        storage.set("tars_tpdrWorkflow", states);
      }

      function getThresholds() {
        return storage.get("tars_tpdrThresholds") || Object.assign({}, TPDR_THRESHOLD_DEFAULTS);
      }

      function setThresholds(vals) {
        storage.set("tars_tpdrThresholds", vals);
      }

      function getMonthlyRate(rec, window) {
        var counts = rec.monthly_counts || [];
        if (counts.length === 0) return 0;
        var w = window || counts.length;
        if (w > counts.length) w = counts.length;
        var slice = counts.slice(counts.length - w);
        var sum = 0;
        for (var i = 0; i < slice.length; i++) sum += slice[i];
        return sum / slice.length;
      }

      function getSelectedActivities() {
        return storage.get("tars_tpdrSelectedActivities") || null;
      }

      function setSelectedActivities(arr) {
        storage.set("tars_tpdrSelectedActivities", arr);
      }

      function passesThresholds(rec, thresholds) {
        if ((rec.total_tars || 0) < thresholds.minTotalTars) return false;
        if ((rec.aircraft_count || 0) < thresholds.minAircraft) return false;
        if ((rec.acceleration_ratio || 0) < thresholds.minAcceleration) return false;
        if ((rec.comeback_count || 0) < thresholds.minComebacks) return false;
        if (thresholds.minMonthlyRate > 0 && getMonthlyRate(rec, thresholds.recentWindow) < thresholds.minMonthlyRate) return false;
        var selActs = getSelectedActivities();
        if (selActs && selActs.length > 0) {
          var recActs = rec.activities || [];
          var hasMatch = false;
          for (var i = 0; i < recActs.length; i++) {
            if (selActs.indexOf(recActs[i]) !== -1) { hasMatch = true; break; }
          }
          if (!hasMatch) return false;
        }
        return true;
      }

      /* ----------------------------------------------------------------
         RENDER TPDR CANDIDATES
         ---------------------------------------------------------------- */
      // Persistent DOM refs so the threshold panel survives candidate re-renders
      var _tpdrPersist = null;

      function _tpdrComputeLists(recs) {
        var workflowStates = getWorkflowStates();
        var thresholds = getThresholds();
        var activeRecs = [];
        var deferredRecs = [];
        var filedRecs = [];
        var displayCount = Math.min(15, recs.length);

        for (var i = 0; i < displayCount; i++) {
          var rec = recs[i];
          rec._origRank = i + 1;
          var ws = workflowStates[rec.uns];
          if (ws && ws.state === "filed") {
            filedRecs.push(rec);
          } else if (ws && ws.state === "deferred") {
            deferredRecs.push(rec);
          } else {
            activeRecs.push(rec);
          }
        }
        var filteredActive = activeRecs.filter(function(rec) {
          return passesThresholds(rec, thresholds);
        });
        return {
          workflowStates: workflowStates,
          displayCount: displayCount,
          activeRecs: activeRecs,
          deferredRecs: deferredRecs,
          filedRecs: filedRecs,
          filteredActive: filteredActive
        };
      }

      function _tpdrRenderCards(recs) {
        var p = _tpdrPersist;
        var lists = _tpdrComputeLists(recs);
        var cardsZone = p.cardsZone;
        while (cardsZone.firstChild) cardsZone.removeChild(cardsZone.firstChild);

        // Update stats bar counts
        p.statsFiled.textContent = String(lists.filedRecs.length);
        p.statsDeferred.textContent = String(lists.deferredRecs.length);
        p.statsActive.textContent = String(lists.filteredActive.length);

        // Update threshold count text
        p.countFiltered.textContent = String(lists.filteredActive.length);
        p.countTotal.textContent = String(lists.activeRecs.length);

        // Active candidates
        if (lists.filteredActive.length > 0) {
          lists.filteredActive.forEach(function(rec) {
            cardsZone.appendChild(buildCandidateCard(rec, "active", lists.workflowStates));
          });
        } else if (lists.activeRecs.length > 0) {
          cardsZone.appendChild(h("div", { className: "state-message", style: { padding: "16px 0" } }, [
            h("p", { className: "state-message__text" }, ["No active candidates match current thresholds."])
          ]));
        }

        // Deferred section
        if (lists.deferredRecs.length > 0) {
          cardsZone.appendChild(h("div", { className: "tpdr-section-header tpdr-section-header--deferred" }, [
            "Deferred Candidates (" + lists.deferredRecs.length + ")"
          ]));
          lists.deferredRecs.forEach(function(rec) {
            cardsZone.appendChild(buildCandidateCard(rec, "deferred", lists.workflowStates));
          });
        }

        // Filed section
        if (lists.filedRecs.length > 0) {
          cardsZone.appendChild(h("div", { className: "tpdr-section-header tpdr-section-header--filed" }, [
            "Filed TPDRs (" + lists.filedRecs.length + ")"
          ]));
          lists.filedRecs.forEach(function(rec) {
            cardsZone.appendChild(buildFiledCard(rec, lists.workflowStates));
          });
        }
      }

      function renderTPDRCandidates(recs) {
        var container = tpdrDom.tpdrCandidatesResults;

        if (!recs || recs.length === 0) {
          _tpdrPersist = null;
          while (container.firstChild) container.removeChild(container.firstChild);
          container.appendChild(h("div", { className: "state-message" }, [
            h("p", { className: "state-message__text" }, ["No TPDR candidates found."])
          ]));
          show(container);
          return;
        }

        // If panel already exists, just refresh the cards zone
        if (_tpdrPersist) {
          _tpdrRenderCards(recs);
          show(container);
          return;
        }

        // First render  build the full layout
        while (container.firstChild) container.removeChild(container.firstChild);

        var lists = _tpdrComputeLists(recs);

        // Stats bar with updatable spans
        var statsFiled = h("span", null, [String(lists.filedRecs.length)]);
        var statsDeferred = h("span", null, [String(lists.deferredRecs.length)]);
        var statsActive = h("span", null, [String(lists.filteredActive.length)]);
        var statsBar = h("div", { className: "tpdr-stats-bar" }, [
          h("span", null, [String(lists.displayCount)]),
          " candidates",
          h("span", { style: { marginLeft: "8px" } }, [statsFiled]),
          " filed",
          h("span", { style: { marginLeft: "8px" } }, [statsDeferred]),
          " deferred",
          h("span", { style: { marginLeft: "8px" } }, [statsActive]),
          " active"
        ]);
        container.appendChild(statsBar);

        // Cards zone (rebuilt on every filter change)
        var cardsZone = h("div", null);

        // Store persistent refs before buildThresholdPanel so it can wire up count spans
        _tpdrPersist = {
          cardsZone: cardsZone,
          statsFiled: statsFiled,
          statsDeferred: statsDeferred,
          statsActive: statsActive,
          countFiltered: null,
          countTotal: null
        };

        // Threshold panel (built once, persisted)
        var thresholds = getThresholds();
        container.appendChild(buildThresholdPanel(thresholds, lists.activeRecs.length, lists.filteredActive.length));
        container.appendChild(cardsZone);

        // Render initial cards
        _tpdrRenderCards(recs);
        show(container);
      }

      /* ----------------------------------------------------------------
         BUILD CANDIDATE CARD (active or deferred)
         ---------------------------------------------------------------- */
      function buildCandidateCard(rec, state, workflowStates) {
        var colors = accelColor(rec.acceleration_ratio);
        var cardId = "tpdr-detail-" + rec._origRank;

        // Header with rank, score, and workflow buttons or badge
        var headerChildren = [
          h("div", { className: "tpdr-candidate__rank" }, [
            h("span", { className: "tpdr-candidate__rank-num" }, ["#" + rec._origRank]),
            h("span", { className: "tpdr-score-badge" }, ["Score: " + Math.round(rec.score)])
          ])
        ];

        if (state === "active") {
          var fileBtn = h("button", {
            type: "button",
            className: "tpdr-workflow-btn tpdr-workflow-btn--file"
          }, ["Mark as Filed"]);
          var deferBtn = h("button", {
            type: "button",
            className: "tpdr-workflow-btn tpdr-workflow-btn--defer"
          }, ["Defer"]);

          (function(uns, fb, db) {
            fb.addEventListener("click", function(e) {
              e.stopPropagation();
              setWorkflowState(uns, "filed");
              renderTPDRCandidates(tpdrData.recommendations);
            });
            db.addEventListener("click", function(e) {
              e.stopPropagation();
              showDeferInput(uns, card);
            });
          })(rec.uns, fileBtn, deferBtn);

          headerChildren.push(h("div", { style: { display: "flex", gap: "6px", alignItems: "center" } }, [fileBtn, deferBtn]));
        } else if (state === "deferred") {
          var undoBtn = h("button", {
            type: "button",
            className: "tpdr-undo-link"
          }, ["Undo"]);
          (function(uns, btn) {
            btn.addEventListener("click", function(e) {
              e.stopPropagation();
              setWorkflowState(uns, "active");
              renderTPDRCandidates(tpdrData.recommendations);
            });
          })(rec.uns, undoBtn);

          headerChildren.push(h("div", { style: { display: "flex", gap: "6px", alignItems: "center" } }, [
            h("span", { className: "tpdr-state-badge tpdr-state-badge--deferred" }, ["Deferred"]),
            undoBtn
          ]));
        }

        var header = h("div", { className: "tpdr-candidate__header" }, headerChildren);

        var title = h("div", { className: "tpdr-candidate__title" }, [rec.uns]);

        var statsGrid = h("div", { className: "tpdr-stats-grid" }, [
          h("div", { className: "tpdr-stat-box" }, [
            h("div", { className: "tpdr-stat-box__value" }, [formatNumber(rec.total_tars)]),
            h("div", { className: "tpdr-stat-box__label" }, ["Total TARs"])
          ]),
          h("div", { className: "tpdr-stat-box" }, [
            h("div", { className: "tpdr-stat-box__value", style: { color: colors.color } }, [rec.acceleration_ratio + "x"]),
            h("div", { className: "tpdr-stat-box__label" }, ["Accel. Rate"])
          ]),
          h("div", { className: "tpdr-stat-box" }, [
            h("div", { className: "tpdr-stat-box__value" }, [String(rec.aircraft_count)]),
            h("div", { className: "tpdr-stat-box__label" }, ["Aircraft Affected"])
          ]),
          h("div", { className: "tpdr-stat-box" }, [
            h("div", { className: "tpdr-stat-box__value" }, [String(rec.comeback_count || 0)]),
            h("div", { className: "tpdr-stat-box__label" }, ["Comebacks (90-day)"])
          ])
        ]);

        var sparklineRow = h("div", { className: "tpdr-sparkline-row" }, [
          h("span", { className: "tpdr-sparkline-label" }, ["Trend:"]),
          createSparkline(rec.monthly_counts || [], 120, 24, colors.color)
        ]);

        var justificationEl = null;
        if (rec.justification) {
          justificationEl = h("div", { className: "tpdr-justification" }, [
            h("div", { className: "tpdr-justification__label" }, ["AI Justification"]),
            h("div", { className: "tpdr-justification__text" }, [rec.justification])
          ]);
        }

        var toggleBtn = h("button", {
          type: "button",
          className: "tpdr-details-toggle",
          "data-target": cardId
        }, ["View Details"]);

        var detailSection = h("div", { id: cardId, className: "tpdr-detail hidden" });
        buildDetailContent(detailSection, rec);

        (function(btn, detail) {
          btn.addEventListener("click", function() {
            if (detail.classList.contains("hidden")) {
              show(detail);
              btn.textContent = "Hide Details";
            } else {
              hide(detail);
              btn.textContent = "View Details";
            }
          });
        })(toggleBtn, detailSection);

        var cardChildren = [header, title, statsGrid, sparklineRow];
        if (justificationEl) cardChildren.push(justificationEl);

        // Deferred note
        if (state === "deferred") {
          var ws = workflowStates[rec.uns];
          if (ws && ws.note) {
            cardChildren.push(h("div", { style: { fontStyle: "italic", color: "var(--text-muted)", fontSize: "0.8125rem", marginBottom: "8px" } }, [ws.note]));
          }
        }

        cardChildren.push(toggleBtn, detailSection);

        var cardClass = "tpdr-candidate";
        if (state === "deferred") cardClass += " tpdr-candidate--deferred";

        var card = h("div", { className: cardClass }, cardChildren);
        return card;
      }

      /* ----------------------------------------------------------------
         BUILD FILED CARD (compact summary)
         ---------------------------------------------------------------- */
      function buildFiledCard(rec, workflowStates) {
        var ws = workflowStates[rec.uns];
        var timestamp = ws && ws.timestamp ? new Date(ws.timestamp).toLocaleDateString() : "";

        var undoBtn = h("button", {
          type: "button",
          className: "tpdr-undo-link"
        }, ["Undo"]);
        (function(uns, btn) {
          btn.addEventListener("click", function(e) {
            e.stopPropagation();
            setWorkflowState(uns, "active");
            renderTPDRCandidates(tpdrData.recommendations);
          });
        })(rec.uns, undoBtn);

        return h("div", { className: "tpdr-candidate tpdr-candidate--filed" }, [
          h("div", { style: { display: "flex", alignItems: "center", justifyContent: "space-between", flexWrap: "wrap", gap: "8px" } }, [
            h("div", { style: { display: "flex", alignItems: "center", gap: "10px" } }, [
              h("span", { className: "tpdr-candidate__rank-num" }, ["#" + rec._origRank]),
              h("span", { style: { fontWeight: "600", color: "var(--text-primary)", fontSize: "0.875rem" } }, [rec.uns]),
              h("span", { className: "tpdr-score-badge" }, ["Score: " + Math.round(rec.score)])
            ]),
            h("div", { style: { display: "flex", alignItems: "center", gap: "8px" } }, [
              h("span", { className: "tpdr-state-badge tpdr-state-badge--filed" }, ["Filed"]),
              timestamp ? h("span", { style: { fontSize: "0.6875rem", color: "var(--text-muted)" } }, [timestamp]) : null,
              undoBtn
            ])
          ])
        ]);
      }

      /* ----------------------------------------------------------------
         SHOW DEFER INPUT
         ---------------------------------------------------------------- */
      function showDeferInput(uns, card) {
        // Remove any existing defer input in this card
        var existing = card.querySelector(".tpdr-defer-input");
        if (existing) { card.removeChild(existing); return; }

        var noteInput = h("input", {
          type: "text",
          placeholder: "Add a note (optional)..."
        });
        var saveBtn = h("button", { type: "button" }, ["Save"]);

        (function(u, inp, btn) {
          btn.addEventListener("click", function() {
            setWorkflowState(u, "deferred", inp.value || "");
            renderTPDRCandidates(tpdrData.recommendations);
          });
          inp.addEventListener("keydown", function(e) {
            if (e.key === "Enter") {
              setWorkflowState(u, "deferred", inp.value || "");
              renderTPDRCandidates(tpdrData.recommendations);
            }
          });
        })(uns, noteInput, saveBtn);

        var inputRow = h("div", { className: "tpdr-defer-input" }, [
          noteInput,
          saveBtn
        ]);

        // Insert after the header
        var headerEl = card.querySelector(".tpdr-candidate__header");
        if (headerEl && headerEl.nextSibling) {
          card.insertBefore(inputRow, headerEl.nextSibling);
        } else {
          card.appendChild(inputRow);
        }
        noteInput.focus();
      }

      /* ----------------------------------------------------------------
         BUILD THRESHOLD PANEL
         ---------------------------------------------------------------- */
      function collectAllActivities(recs) {
        var actMap = {};
        var displayCount = Math.min(15, recs.length);
        for (var i = 0; i < displayCount; i++) {
          var acts = recs[i].activities || [];
          for (var j = 0; j < acts.length; j++) {
            actMap[acts[j]] = (actMap[acts[j]] || 0) + 1;
          }
        }
        return Object.keys(actMap).sort(function(a, b) {
          return actMap[b] - actMap[a];
        });
      }

      function buildThresholdPanel(thresholds, totalActive, filteredCount) {
        var panelContent = h("div", { className: "hidden" });
        var toggleBtn = h("button", {
          type: "button",
          className: "threshold-toggle"
        }, ["Configure Thresholds"]);

        (function(btn, content) {
          btn.addEventListener("click", function() {
            if (content.classList.contains("hidden")) {
              show(content);
              btn.textContent = "Hide Thresholds";
            } else {
              hide(content);
              btn.textContent = "Configure Thresholds";
            }
          });
        })(toggleBtn, panelContent);

        var fields = [
          { key: "minTotalTars", label: "Min Total TARs", min: 1, max: 500, step: 1, tip: "Minimum number of related TARs filed for this system" },
          { key: "minAircraft", label: "Min Aircraft Affected", min: 1, max: 100, step: 1, tip: "Minimum number of different aircraft reporting this problem" },
          { key: "minAcceleration", label: "Min Acceleration Rate", min: 0.5, max: 20, step: 0.5, tip: "How much faster TARs are coming in. 2.0x = doubled, 3.0x = tripled" },
          { key: "minComebacks", label: "Min Comebacks", min: 0, max: 50, step: 1, tip: "Times the same aircraft had the same problem again within 90 days" },
          { key: "minMonthlyRate", label: "Min Monthly Rate", min: 0, max: 100, step: 0.5, tip: "Average TARs per month during the recent window" }
        ];

        // Summary sentence with live-updating values
        function makeTv(text) {
          return h("span", { className: "tv" }, [text]);
        }
        var svWindow = makeTv(String(thresholds.recentWindow) + " months");
        var svTars = makeTv(String(thresholds.minTotalTars));
        var svAircraft = makeTv(String(thresholds.minAircraft));
        var svAccel = makeTv(String(thresholds.minAcceleration) + "x");
        var svComebacks = makeTv(String(thresholds.minComebacks));
        var svRate = makeTv(String(thresholds.minMonthlyRate));

        var summaryEl = h("div", { className: "threshold-summary" }, [
          "A system is flagged as a TPDR candidate when, within the last ", svWindow,
          ", it has at least ", svTars,
          " TARs that the AI grouped as related, across at least ", svAircraft,
          " aircraft, with the problem accelerating at ", svAccel,
          " or faster, at least ", svComebacks,
          " comeback where the initial fix did not hold, and a submission rate of at least ", svRate,
          " TARs per month."
        ]);
        panelContent.appendChild(summaryEl);

        function updateSummary() {
          var t = getThresholds();
          svWindow.textContent = String(t.recentWindow) + " months";
          svTars.textContent = String(t.minTotalTars);
          svAircraft.textContent = String(t.minAircraft);
          svAccel.textContent = String(t.minAcceleration) + "x";
          svComebacks.textContent = String(t.minComebacks);
          svRate.textContent = String(t.minMonthlyRate);
        }

        function makeTip(text) {
          var icon = h("span", { className: "threshold-tip" }, [
            "?",
            h("span", { className: "threshold-tiptext" }, [text])
          ]);
          return icon;
        }

        var grid = h("div", { className: "threshold-grid" });
        var inputs = {};

        fields.forEach(function(f) {
          var inp = h("input", {
            type: "number",
            min: String(f.min),
            max: String(f.max),
            step: String(f.step),
            value: String(thresholds[f.key])
          });
          inputs[f.key] = inp;

          (function(input, key) {
            input.addEventListener("change", function() {
              var val = parseFloat(input.value);
              if (isNaN(val)) return;
              var current = getThresholds();
              current[key] = val;
              setThresholds(current);
              updateSummary();
              _tpdrRenderCards(tpdrData.recommendations);
            });
          })(inp, f.key);

          grid.appendChild(h("div", { className: "threshold-field" }, [
            h("label", null, [f.label, makeTip(f.tip)]),
            inp
          ]));
        });

        var windowSelect = h("select", null);
        [3, 6, 12].forEach(function(m) {
          var opt = h("option", { value: String(m) }, [m + " months"]);
          if (m === (thresholds.recentWindow || 6)) opt.selected = true;
          windowSelect.appendChild(opt);
        });
        windowSelect.addEventListener("change", function() {
          var current = getThresholds();
          current.recentWindow = parseInt(windowSelect.value, 10);
          setThresholds(current);
          updateSummary();
          _tpdrRenderCards(tpdrData.recommendations);
        });
        grid.appendChild(h("div", { className: "threshold-field" }, [
          h("label", null, ["Recent Window", makeTip("How far back to look when calculating monthly submission rate")]),
          windowSelect
        ]));

        panelContent.appendChild(grid);

        // Activity / Unit multi-select
        var allActivities = tpdrData ? collectAllActivities(tpdrData.recommendations) : [];
        var chipContainer = null;
        if (allActivities.length > 0) {
          var selActs = getSelectedActivities() || [];

          panelContent.appendChild(h("div", { className: "threshold-multiselect-label" }, ["Filter by Activity / Unit"]));

          chipContainer = h("div", { className: "threshold-multiselect" });

          allActivities.forEach(function(act) {
            var isActive = selActs.indexOf(act) !== -1;
            var chip = h("button", {
              type: "button",
              className: "threshold-chip" + (isActive ? " threshold-chip--active" : "")
            }, [act]);

            (function(activity, chipEl) {
              chipEl.addEventListener("click", function() {
                chipEl.classList.toggle("threshold-chip--active");
                var current = getSelectedActivities() || [];
                var idx = current.indexOf(activity);
                if (idx !== -1) {
                  current.splice(idx, 1);
                } else {
                  current.push(activity);
                }
                setSelectedActivities(current.length > 0 ? current : null);
                _tpdrRenderCards(tpdrData.recommendations);
              });
            })(act, chip);

            chipContainer.appendChild(chip);
          });

          panelContent.appendChild(chipContainer);

          var selectAllBtn = h("button", { type: "button", className: "threshold-link-btn" }, ["Select All"]);
          var clearAllBtn = h("button", { type: "button", className: "threshold-link-btn" }, ["Clear All"]);

          selectAllBtn.addEventListener("click", function() {
            setSelectedActivities(allActivities.slice());
            syncChipVisuals(chipContainer, allActivities);
            _tpdrRenderCards(tpdrData.recommendations);
          });
          clearAllBtn.addEventListener("click", function() {
            setSelectedActivities(null);
            syncChipVisuals(chipContainer, null);
            _tpdrRenderCards(tpdrData.recommendations);
          });

          panelContent.appendChild(h("div", { className: "threshold-multiselect-actions" }, [selectAllBtn, clearAllBtn]));
        }

        var countFiltered = h("span", null, [String(filteredCount)]);
        var countTotal = h("span", null, [String(totalActive)]);
        var countText = h("div", { className: "threshold-count" }, [
          "Showing ", countFiltered, " of ", countTotal, " active candidates matching thresholds"
        ]);

        // Store count refs so _tpdrRenderCards can update them
        if (_tpdrPersist) {
          _tpdrPersist.countFiltered = countFiltered;
          _tpdrPersist.countTotal = countTotal;
        }

        var resetBtn = h("button", {
          type: "button",
          className: "tpdr-workflow-btn",
          style: { color: "var(--text-secondary)", borderColor: "var(--border-color)" }
        }, ["Reset to Defaults"]);

        resetBtn.addEventListener("click", function() {
          var defaults = Object.assign({}, TPDR_THRESHOLD_DEFAULTS);
          setThresholds(defaults);
          setSelectedActivities(null);
          // Reset input values in place
          Object.keys(inputs).forEach(function(key) {
            inputs[key].value = String(defaults[key]);
          });
          // Reset window select
          windowSelect.value = String(defaults.recentWindow);
          // Reset chip visuals
          if (chipContainer) syncChipVisuals(chipContainer, null);
          updateSummary();
          _tpdrRenderCards(tpdrData.recommendations);
        });

        var actions = h("div", { className: "threshold-actions" }, [countText, resetBtn]);
        panelContent.appendChild(actions);

        var panel = h("div", { className: "threshold-panel" }, [toggleBtn, panelContent]);
        return panel;
      }

      function syncChipVisuals(container, activeList) {
        var chips = container.children;
        for (var i = 0; i < chips.length; i++) {
          if (activeList && activeList.indexOf(chips[i].textContent) !== -1) {
            chips[i].classList.add("threshold-chip--active");
          } else {
            chips[i].classList.remove("threshold-chip--active");
          }
        }
      }

      /* ----------------------------------------------------------------
         BUILD DETAIL CONTENT
         ---------------------------------------------------------------- */
      function buildDetailContent(container, rec) {
        if (rec.monthly_counts && rec.monthly_counts.length > 0) {
          var chartSection = h("div", { className: "tpdr-detail__section" }, [
            h("div", { className: "tpdr-detail__section-title" }, ["Monthly TAR Timeline"])
          ]);
          var maxVal = Math.max.apply(null, rec.monthly_counts);
          if (maxVal === 0) maxVal = 1;
          var colors = accelColor(rec.acceleration_ratio);

          var barContainer = h("div", { className: "tpdr-bar-chart" });
          var labelsContainer = h("div", { className: "tpdr-bar-labels" });

          rec.monthly_counts.forEach(function(count, idx) {
            var heightPct = (count / maxVal) * 100;
            var bar = h("div", {
              className: "tpdr-bar",
              style: { height: Math.max(heightPct, 2) + "%", background: colors.color },
              title: (rec.months_labels && rec.months_labels[idx] ? rec.months_labels[idx] + ": " : "") + count + " TARs"
            });
            barContainer.appendChild(bar);

            var label = rec.months_labels && rec.months_labels[idx] ? rec.months_labels[idx].slice(-2) : "";
            labelsContainer.appendChild(h("div", { className: "tpdr-bar-label" }, [label]));
          });

          chartSection.appendChild(barContainer);
          chartSection.appendChild(labelsContainer);
          container.appendChild(chartSection);
        }

        if (rec.affected_aircraft && rec.affected_aircraft.length > 0) {
          var aircraftSection = h("div", { className: "tpdr-detail__section" }, [
            h("div", { className: "tpdr-detail__section-title" }, ["Affected Aircraft (" + rec.aircraft_count + ")"])
          ]);
          var aircraftList = h("div", { className: "tpdr-aircraft-list" });
          rec.affected_aircraft.forEach(function(buno) {
            aircraftList.appendChild(h("span", { className: "tpdr-aircraft-badge" }, [buno]));
          });
          aircraftSection.appendChild(aircraftList);
          container.appendChild(aircraftSection);
        }

        if (rec.example_comebacks && rec.example_comebacks.length > 0) {
          var cbSection = h("div", { className: "tpdr-detail__section" }, [
            h("div", { className: "tpdr-detail__section-title" }, ["Comeback Instances"])
          ]);
          var table = h("table", { className: "tpdr-comeback-table" });
          var thead = h("thead", null, [
            h("tr", null, [
              h("th", null, ["Aircraft"]),
              h("th", null, ["First Date"]),
              h("th", null, ["Second Date"]),
              h("th", null, ["Gap (days)"])
            ])
          ]);
          table.appendChild(thead);
          var tbody = h("tbody");
          rec.example_comebacks.forEach(function(cb) {
            tbody.appendChild(h("tr", null, [
              h("td", null, [cb.buno || ""]),
              h("td", null, [cb.date_first || ""]),
              h("td", null, [cb.date_second || ""]),
              h("td", null, [String(cb.gap_days || "")])
            ]));
          });
          table.appendChild(tbody);
          cbSection.appendChild(table);
          container.appendChild(cbSection);
        }

        if (rec.activities && rec.activities.length > 0) {
          var unitsSection = h("div", { className: "tpdr-detail__section" }, [
            h("div", { className: "tpdr-detail__section-title" }, ["Units Affected"])
          ]);
          var unitsList = h("div", { className: "tpdr-aircraft-list" });
          rec.activities.forEach(function(unit) {
            unitsList.appendChild(h("span", { className: "tpdr-aircraft-badge" }, [unit]));
          });
          unitsSection.appendChild(unitsList);
          container.appendChild(unitsSection);
        }

        if (rec.linked_cluster) {
          container.appendChild(h("div", { className: "tpdr-detail__section" }, [
            h("div", { className: "tpdr-detail__section-title" }, ["Linked Problem Category"]),
            h("div", { style: { color: "var(--accent-blue)", fontSize: "0.875rem" } }, [rec.linked_cluster])
          ]));
        }

        if (rec.sample_tars && rec.sample_tars.length > 0) {
          var sampleSection = h("div", { className: "tpdr-detail__section" }, [
            h("div", { className: "tpdr-detail__section-title" }, ["Sample TARs"])
          ]);
          rec.sample_tars.forEach(function(tar) {
            sampleSection.appendChild(h("div", { style: { marginBottom: "8px", padding: "8px 12px", background: "var(--bg-secondary)", borderRadius: "var(--radius-sm)", fontSize: "0.8125rem" } }, [
              h("span", { style: { color: "var(--accent-cyan)", fontFamily: "var(--font-mono)", marginRight: "8px" } }, ["JCN: " + (tar.jcn || "N/A")]),
              h("span", { style: { color: "var(--text-secondary)" } }, [tar.subject || ""]),
              tar.submit_date ? h("span", { style: { color: "var(--text-muted)", marginLeft: "8px", fontSize: "0.75rem" } }, [tar.submit_date]) : null
            ]));
          });
          container.appendChild(sampleSection);
        }
      }

      /* ----------------------------------------------------------------
         RENDER FLEET TRENDS
         ---------------------------------------------------------------- */
      function renderTPDRTrends(trends) {
        var container = tpdrDom.tpdrTrendsResults;
        while (container.firstChild) container.removeChild(container.firstChild);

        if (!trends || trends.length === 0) {
          show(container);
          return;
        }

        var accelerating = trends.filter(function(t) { return t.acceleration_ratio >= 2.0; });
        var declining = trends.filter(function(t) { return t.acceleration_ratio < 1.0; });

        if (accelerating.length > 0) {
          var accelSection = h("div", { className: "tpdr-trend-section" }, [
            h("div", { className: "tpdr-trend-section__title" }, ["Accelerating Systems"])
          ]);
          accelerating.slice(0, 15).forEach(function(t) {
            var colors = accelColor(t.acceleration_ratio);
            accelSection.appendChild(h("div", { className: "tpdr-trend-item" }, [
              h("span", { className: "tpdr-trend-dot " + colors.dot }),
              h("span", { className: "tpdr-trend-name" }, [t.uns]),
              h("span", { className: "tpdr-trend-ratio " + colors.ratio }, [t.acceleration_ratio + "x"]),
              createSparkline(t.monthly_counts || [], 80, 20, colors.color)
            ]));
          });
          container.appendChild(accelSection);
        }

        if (declining.length > 0) {
          declining.sort(function(a, b) { return a.acceleration_ratio - b.acceleration_ratio; });
          var declineSection = h("div", { className: "tpdr-trend-section" }, [
            h("div", { className: "tpdr-trend-section__title" }, ["Declining Systems"])
          ]);
          declining.slice(0, 10).forEach(function(t) {
            var colors = accelColor(t.acceleration_ratio);
            declineSection.appendChild(h("div", { className: "tpdr-trend-item" }, [
              h("span", { className: "tpdr-trend-dot " + colors.dot }),
              h("span", { className: "tpdr-trend-name" }, [t.uns]),
              h("span", { className: "tpdr-trend-ratio " + colors.ratio }, [t.acceleration_ratio + "x"]),
              createSparkline(t.monthly_counts || [], 80, 20, colors.color)
            ]));
          });
          container.appendChild(declineSection);
        }

        show(container);
      }

      /* ----------------------------------------------------------------
         FLEET ANALYTICS -- LOAD DATA
         ---------------------------------------------------------------- */
      async function loadFleetData() {
        show(tpdrDom.fleetLoading);
        hide(tpdrDom.fleetError);
        hide(tpdrDom.fleetResults);

        try {
          var clusters = await apiGet("/api/clusters");
          var parts = await apiGet("/api/parts");
          var stats = await apiGet("/api/stats");

          fleetData = { clusters: clusters, parts: parts, stats: stats };
          fleetLoaded = true;

          hide(tpdrDom.fleetLoading);
          renderFleetStats(stats);
          renderFleetClusters(clusters);
          renderFleetParts(parts);
          show(tpdrDom.fleetResults);
        } catch (e) {
          hide(tpdrDom.fleetLoading);
          tpdrDom.fleetErrorText.textContent = "Failed to load fleet analytics: " + e.message;
          show(tpdrDom.fleetError);
        }
      }

      /* ----------------------------------------------------------------
         FLEET ANALYTICS -- RENDER STATS
         ---------------------------------------------------------------- */
      function renderFleetStats(stats) {
        var container = document.getElementById("fleetStatsRow");
        if (!container) return;
        while (container.firstChild) container.removeChild(container.firstChild);

        var items = [
          { value: formatNumber(stats.total_tars), label: "TARs Analyzed" },
          { value: formatNumber(stats.total_mafs), label: "MAF Records" },
          { value: String(stats.cluster_count), label: "Problem Categories" },
          { value: String(stats.parts_tracked), label: "Parts Tracked" }
        ];

        items.forEach(function(item) {
          container.appendChild(h("div", { className: "fleet-stat-box" }, [
            h("div", { className: "fleet-stat-box__value" }, [item.value]),
            h("div", { className: "fleet-stat-box__label" }, [item.label])
          ]));
        });
      }

      /* ----------------------------------------------------------------
         FLEET ANALYTICS -- RENDER CLUSTERS CHART
         ---------------------------------------------------------------- */
      function renderFleetClusters(clusters) {
        var container = document.getElementById("fleetClustersChart");
        if (!container) return;
        while (container.firstChild) container.removeChild(container.firstChild);
        if (!clusters || clusters.length === 0) return;

        var sorted = clusters.slice().sort(function(a, b) { return b.occurrences - a.occurrences; });
        var maxCount = sorted[0].occurrences;

        var chartColors = [
          "var(--bar-replace)", "var(--bar-inspect)", "var(--bar-adjust)",
          "var(--bar-repair)", "var(--bar-other)", "var(--accent-blue)",
          "var(--accent-cyan)", "var(--accent-green)", "var(--accent-amber)",
          "var(--accent-purple)"
        ];

        sorted.forEach(function(cluster, idx) {
          var pct = (cluster.occurrences / maxCount) * 100;
          var color = chartColors[idx % chartColors.length];
          var detailId = "fleet-cluster-detail-" + idx;

          var row = h("div", {
            className: "fleet-bar-row",
            tabindex: "0",
            role: "button",
            ariaExpanded: "false",
            ariaControls: detailId
          }, [
            h("div", { className: "fleet-bar-row__label", title: cluster.problem }, [cluster.problem]),
            h("div", { className: "fleet-bar-row__track" }, [
              h("div", { className: "fleet-bar-row__fill", style: { width: pct + "%", background: color } })
            ]),
            h("div", { className: "fleet-bar-row__value" }, [formatNumber(cluster.occurrences)])
          ]);

          var detail = h("div", { id: detailId, className: "fleet-detail hidden" });
          buildFleetClusterDetail(detail, cluster);

          (function(r, d) {
            function toggle() {
              if (d.classList.contains("hidden")) {
                show(d);
                r.setAttribute("aria-expanded", "true");
              } else {
                hide(d);
                r.setAttribute("aria-expanded", "false");
              }
            }
            r.addEventListener("click", toggle);
            r.addEventListener("keydown", function(e) {
              if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggle(); }
            });
          })(row, detail);

          container.appendChild(row);
          container.appendChild(detail);
        });
      }

      /* ----------------------------------------------------------------
         FLEET ANALYTICS -- BUILD CLUSTER DETAIL CARD
         ---------------------------------------------------------------- */
      function buildFleetClusterDetail(container, cluster) {
        var grid = h("div", { className: "fleet-detail__grid" });

        // Left column: solution breakdown + stats
        var leftCol = h("div");

        if (cluster.solution_breakdown) {
          var breakdownSection = h("div", { className: "fleet-detail__section" }, [
            h("div", { className: "fleet-detail__section-title" }, ["Solution Breakdown"])
          ]);

          var entries = Object.keys(cluster.solution_breakdown).map(function(key) {
            return { action: key, pct: cluster.solution_breakdown[key] };
          }).sort(function(a, b) { return b.pct - a.pct; });

          entries.forEach(function(entry, idx) {
            breakdownSection.appendChild(h("div", { className: "solution-item" }, [
              h("span", { className: "solution-item__label" }, [entry.action]),
              h("div", { className: "solution-item__bar-track" }, [
                h("div", { className: "solution-item__bar-fill", style: { width: entry.pct + "%", background: getBarColor(idx) } })
              ]),
              h("span", { className: "solution-item__pct" }, [entry.pct.toFixed(1) + "%"])
            ]));
          });

          leftCol.appendChild(breakdownSection);
        }

        var statsSection = h("div", { className: "fleet-detail__section" }, [
          h("div", { className: "fleet-detail__section-title" }, ["Details"])
        ]);

        if (cluster.occurrences) {
          statsSection.appendChild(h("div", { style: { marginBottom: "4px", fontSize: "0.8125rem", color: "var(--text-secondary)" } }, [
            h("strong", { style: { color: "var(--accent-cyan)", fontFamily: "var(--font-mono)" } }, [formatNumber(cluster.occurrences)]),
            " occurrences"
          ]));
        }
        if (cluster.average_manhours) {
          statsSection.appendChild(h("div", { style: { marginBottom: "4px", fontSize: "0.8125rem", color: "var(--text-secondary)" } }, [
            h("strong", { style: { color: "var(--accent-amber)", fontFamily: "var(--font-mono)" } }, [String(cluster.average_manhours)]),
            " avg manhours"
          ]));
        }

        leftCol.appendChild(statsSection);
        grid.appendChild(leftCol);

        // Right column: parts + sample JCNs
        var rightCol = h("div");

        if (cluster.parts_commonly_involved && cluster.parts_commonly_involved.length > 0) {
          var partsSection = h("div", { className: "fleet-detail__section" }, [
            h("div", { className: "fleet-detail__section-title" }, ["Parts Commonly Involved"])
          ]);
          var partsList = h("div", { style: { display: "flex", flexWrap: "wrap", gap: "6px" } });
          cluster.parts_commonly_involved.forEach(function(p) {
            partsList.appendChild(h("span", { className: "fleet-parts-badge" }, [p]));
          });
          partsSection.appendChild(partsList);
          rightCol.appendChild(partsSection);
        }

        if (cluster.sample_tar_jcns && cluster.sample_tar_jcns.length > 0) {
          var jcnSection = h("div", { className: "fleet-detail__section" }, [
            h("div", { className: "fleet-detail__section-title" }, ["Sample JCNs"])
          ]);
          var jcnList = h("ul", { className: "fleet-jcn-list" });
          cluster.sample_tar_jcns.forEach(function(jcn) {
            jcnList.appendChild(h("li", null, [jcn]));
          });
          jcnSection.appendChild(jcnList);
          rightCol.appendChild(jcnSection);
        }

        grid.appendChild(rightCol);
        container.appendChild(grid);

        // Extracted Solutions section
        if (cluster.solutions_extracted && cluster.solutions_extracted.length > 0) {
          var solSection = h("div", { className: "fleet-detail__section", style: { marginTop: "16px" } }, [
            h("div", { className: "fleet-detail__section-title" }, ["Extracted Solutions"])
          ]);

          var solTable = h("table", { className: "extracted-solutions-table" });
          solTable.appendChild(h("thead", null, [
            h("tr", null, [
              h("th", null, ["Action"]),
              h("th", null, ["Component"]),
              h("th", null, ["Reference"])
            ])
          ]));

          var solTbody = h("tbody");
          var solLimit = Math.min(10, cluster.solutions_extracted.length);
          for (var si = 0; si < solLimit; si++) {
            var sol = cluster.solutions_extracted[si];
            var actionText = sol.action || "";
            var actionUpper = actionText.toUpperCase();
            var actionColor = "var(--bar-other)";
            if (actionUpper.indexOf("REPLACE") === 0) actionColor = "var(--bar-replace)";
            else if (actionUpper.indexOf("INSPECT") === 0) actionColor = "var(--bar-inspect)";
            else if (actionUpper.indexOf("ADJUST") === 0) actionColor = "var(--bar-adjust)";
            else if (actionUpper.indexOf("REPAIR") === 0) actionColor = "var(--bar-repair)";

            solTbody.appendChild(h("tr", null, [
              h("td", { style: { color: actionColor, fontWeight: "600" } }, [actionText]),
              h("td", null, [sol.component || ""]),
              h("td", { style: { fontFamily: "var(--font-mono)", color: "var(--accent-cyan)", fontSize: "0.75rem" } }, [sol.reference || ""])
            ]));
          }
          solTable.appendChild(solTbody);
          solSection.appendChild(solTable);
          container.appendChild(solSection);
        }

        if (cluster.typical_solution) {
          container.appendChild(h("div", { className: "fleet-insight-box" }, [
            h("div", { className: "fleet-insight-box__label" }, ["AI Insight"]),
            h("div", { className: "fleet-insight-box__text" }, [cluster.typical_solution])
          ]));
        }
      }

      /* ----------------------------------------------------------------
         FLEET ANALYTICS -- RENDER PARTS CHART
         ---------------------------------------------------------------- */
      function renderFleetParts(parts) {
        var container = document.getElementById("fleetPartsChart");
        if (!container) return;
        while (container.firstChild) container.removeChild(container.firstChild);
        if (!parts || parts.length === 0) return;

        var maxCount = parts[0].failure_count;

        parts.forEach(function(part, idx) {
          var pct = (part.failure_count / maxCount) * 100;
          var opacity = 0.4 + (pct / 100) * 0.6;
          var detailId = "fleet-part-detail-" + idx;

          var row = h("div", {
            className: "fleet-bar-row",
            tabindex: "0",
            role: "button",
            ariaExpanded: "false",
            ariaControls: detailId
          }, [
            h("div", { className: "fleet-bar-row__label", title: part.part_number, style: { fontFamily: "var(--font-mono)", color: "var(--accent-amber)" } }, [part.part_number]),
            h("div", { className: "fleet-bar-row__track" }, [
              h("div", { className: "fleet-bar-row__fill", style: { width: pct + "%", background: "var(--accent-amber)", opacity: String(opacity) } })
            ]),
            h("div", { className: "fleet-bar-row__value" }, [formatNumber(part.failure_count)])
          ]);

          var detail = h("div", { id: detailId, className: "fleet-detail hidden", style: { borderLeftColor: "var(--accent-amber)" } });

          detail.appendChild(h("div", { style: { marginBottom: "8px" } }, [
            h("strong", { style: { color: "var(--accent-amber)", fontFamily: "var(--font-mono)", fontSize: "1rem" } }, [part.part_number]),
            h("span", { style: { color: "var(--text-muted)", marginLeft: "12px", fontSize: "0.8125rem" } }, [formatNumber(part.failure_count) + " failures"])
          ]));

          if (part.ai_summary) {
            detail.appendChild(h("div", { style: { fontSize: "0.875rem", color: "var(--text-secondary)", lineHeight: "1.6" } }, [part.ai_summary]));
          }

          (function(r, d) {
            function toggle() {
              if (d.classList.contains("hidden")) {
                show(d);
                r.setAttribute("aria-expanded", "true");
              } else {
                hide(d);
                r.setAttribute("aria-expanded", "false");
              }
            }
            r.addEventListener("click", toggle);
            r.addEventListener("keydown", function(e) {
              if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggle(); }
            });
          })(row, detail);

          container.appendChild(row);
          container.appendChild(detail);
        });
      }

      /* ----------------------------------------------------------------
         EVENT HANDLERS
         ---------------------------------------------------------------- */

      dom.btnSearch.addEventListener("click", performSearch);

      // Retry link in AI Recommendation error state
      dom.recommendRetry.addEventListener("click", function(e) {
        e.preventDefault();
        if (searchResults && searchText) {
          fireAutoRecommendation(searchText, searchResults);
        }
      });

      // Ctrl+Enter or Cmd+Enter in textarea triggers search
      dom.tarInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          performSearch();
        }
      });

      // Sample TAR buttons
      document.querySelectorAll(".sample-tar-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          var tarText = this.getAttribute("data-tar");
          dom.tarInput.value = tarText;
          dom.tarInput.focus();
        });
      });

      // Tab navigation
      tpdrDom.tabBtnFleet.addEventListener("click", function() { switchTab("fleet"); });
      tpdrDom.tabBtnLookup.addEventListener("click", function() { switchTab("lookup"); });
      tpdrDom.tabBtnTPDR.addEventListener("click", function() { switchTab("tpdr"); });
      if (tpdrDom.tpdrRefreshBtn) {
        tpdrDom.tpdrRefreshBtn.addEventListener("click", function() {
          tpdrLoaded = false;
          _tpdrPersist = null;
          loadTPDRData();
        });
      }

      /* ----------------------------------------------------------------
         INIT
         ---------------------------------------------------------------- */
      loadStats();
      setInterval(loadStats, 30000);

      // TAR Lookup is the default active tab  load queue immediately
      loadTarQueue();

    })();
  </script>
</body>
</html>
